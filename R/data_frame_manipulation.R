#' Add number of year since start
#'
#' @param .data a df e.g. generated by get_full_data()
add_nb_year_station <- function (.data = NULL) {
  
  output <- .data %>%
    group_by(station) %>%
    mutate(nb_year = year - min(year)) %>%
    ungroup()
  return(output)
}


#' Add biomass value, relative to the first year 
#'
#' @param .data a df e.g. generated by get_full_data()
add_relative_biomass_to_start <- function (.data = NULL) {
  
  output <- .data %>%
    dplyr::group_by(station) %>%
    dplyr::arrange(nb_year) %>%
    dplyr::mutate(rel_bm = (biomass - first(biomass)) / first(biomass)) 
  
  if ("log_bm" %in% names(output)) {

    output %<>% 
      dplyr::mutate(rel_log_bm = (log_bm - first(log_bm)) / first(log_bm))
  
  }

  return(ungroup(output))
}

#' Compute derivate variables
#'
#' @inheritParams add_relative_biomass_to_start 
add_to_full_data <- function (.data = NULL) {

  output <- add_nb_year_station(.data)
  output <- output %>% 
    mutate(
      log_bm = log(biomass),
      bm_std = biomass / surface,
      log_bm_std = log(bm_std)
    )
  output <- add_relative_biomass_to_start(output) 

  return(output)
}

#' Add group to data according to station
#'
#'
add_group_station <- function (.data = NULL, group = NULL) {

  output <- .data %>%
    left_join(group, by = "station")

  return(output)

}

get_bm_vs_network_trends <- function (classif = NULL, bm_var = NULL,
  coeff = c("connectance", "w_trph_lvl_avg", "richness", "weighted_connectance")
  ) {

  var_to_keep <- c("station", "linear_slope", "linear_slope_strd_error")

  bm <- classif[classif$variable == bm_var,] %>%
    unnest(classif) %>%
    select(!!!var_to_keep) %>%
    rename(bm_slope = linear_slope, bm_slope_strd_error = linear_slope_strd_error)

  network <- classif %>%
    filter(!variable %in% get_biomass_var()) %>%
    unnest(classif) %>%
    select(!!!c("variable", var_to_keep))

  output <- bm %>%
    left_join(network, by = "station")

  # Add regression weight
  output %<>%
    mutate( reg_weight = (1 / bm_slope_strd_error +
	1 / linear_slope_strd_error) / 2)

  return(output)
}

get_station_biomass_summary <- function (.data = NULL, bm_var = c("bm_std", "log_bm_std")) {

  var_to_keep <- c("station", "nb_year", bm_var)
  # Prepare
  .data %<>%
    select(!!!var_to_keep) %>%
    pivot_longer(cols = -c(station, nb_year), names_to = "bm_var", values_to = "bm") %>%
    group_by(station, bm_var)

  # Summarise and make it tidy
  bm_summary <- .data %>% 
    summarise(
      first_year = bm[nb_year == 0],
      last_year = bm[nb_year == max(nb_year)],
      first_3_year = mean(bm[nb_year %in% c(0:2)], na.rm = TRUE),
      last_3_year = mean(bm[nb_year %in% c(max(nb_year) - 2:max(nb_year))], na.rm = TRUE),
      median = median(bm, na.rm = TRUE),
      avg = mean(bm, na.rm = TRUE)) %>%
    pivot_longer(cols = c(first_year:avg), names_to = "summary_type", values_to = "bm")

  # Make station group and make it tidy
  bm_group <- bm_summary %>%
    group_by(bm_var, summary_type) %>%
    mutate(
      median = ifelse(bm < median(bm, na.rm = TRUE), "little", "big"),
      avg = ifelse(bm < mean(bm, na.rm = TRUE), "little", "big"),
      quartile = map_chr(bm, function (x, y) {
	if (is.na(x)) return(NA)

	if (x <= y[1])
	  output <- "first_quartile"
	else if (x > y[1] & x <= y[2])
	  output <- "second_quartile"
	else if (x > y[2] & x <= y[3])
	  output <- "third_quartile"
	else if (x > y[3])
	  output <- "fourth_quartile"
	else
	  output <- NA
	return(output)
}, y = quantile(bm, probs = c(.25, .50, .75), na.rm = TRUE)
)) %>%
    pivot_longer(cols = c(median:quartile), names_to = "group_type", values_to = "group") %>%
    ungroup()


}

add_stream_bm_caract_to_model <- function (
  bm_vs_network_df = NULL,
  stream_caract = NULL,
  bm_caract = NULL, 
  bm_group_var = "bm_std",
  bm_sumary_type = "median",
  group_type_caract = "median"
  ) {

  stream_caract %<>%
    filter(group_type == group_type_caract) %>%
    rename(stream_group = group) %>% select(-group_type)
  bm_caract %<>%
    filter(
      group_type == group_type_caract,
      bm_var == bm_group_var,
      summary_type == bm_sumary_type
      ) %>%
  rename(bm_group = group) %>%
  select(-bm_var, -summary_type, -group_type, -bm_var)


  output <- 
    bm_vs_network_df %>%
    left_join(bm_caract, by = "station") %>% 
    left_join(stream_caract, by = "station")
  return(output)

}

#' Get VIF

get_vif <- function (.df = NULL, model_cols = c("mod1", "mod2", "mod3", "mod5")) {

  .df %<>% 
    select(-data) %>%
    pivot_longer(cols = all_of(model_cols), names_to = "model_type", values_to = "model") %>%
    mutate(
      vif_tmp = map(model, ~try(car::vif(.x))),
      vif = map(vif_tmp, ~try(enframe(.x, name = "term", value = "vif")))
    )

  .df %<>%
    mutate(
      check = map2_lgl(vif, vif_tmp,
	~all(class(.x) != "try-error" & class(.y) != "try-error"))) %>%
    filter(check) %>%
    select(-check)

  if ("protocol_type" %in% names(.df)) {
    selected_var <- c("variable", "protocol_type", "model_type", "vif")
  } else {
    selected_var <- c("variable", "model_type", "vif")
  }

  .df %<>% 
    select_at(.vars = vars(all_of(selected_var))) %>%
    filter(!any(class(vif) %in% "try-error")) %>%
    unnest(cols = vif)
  return(.df)

}
