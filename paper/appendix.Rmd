---
title: Appendix
subtitle:
author: Alain Danet, Maud Mouchet, Loubna El Madouri, Elisa Thébault and Colin Fontaine (ordre non fixé)
date: \today 
output:
  bookdown::pdf_document2:
    fig_caption: true 
    keep_tex: true
    toc: true
fontsize: 12pt
header-includes:
   - \usepackage{natbib}
   - \newcommand{\beginsupplement}{\renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}} 
   - \usepackage{float}
   - \usepackage[table]{xcolor}
   - \usepackage{multirow}
   - \usepackage{booktabs}
   - \usepackage{makecell}
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
geometry: margin=2cm
bibliography: references.bib
number_sections: true
---

```{r}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.align = "center",
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE
)
```


```{r, echo = FALSE, message = FALSE, collapse = FALSE}
library(drake)
library(tidyverse)
library(magrittr)
library(ggeffects)
library(cowplot)
library(kableExtra)
library(sf)
library(nlme)

mypath <- rprojroot::find_package_root_file
source(mypath("R/variable_shortcut.R")) # Define your custom code as a bunch of
#functions.

source(mypath("R/misc.R"))
source_dir(mypath("R")) # Define your custom code as a bunch of functions.

mytheme <- theme_cowplot() +
  background_grid()

theme_set(mytheme)
options(knitr.table.format = "latex")
```
```{r}
var_analysis <- c("ct_ff", "w_trph_lvl_avg", "log_rich_std", "log_bm_std",
  "piel_bm", "piel_nind")
```

\beginsupplement

# Data exploration 


## Maps 

```{r}
loadd(p_st_mono_trends_stable_rich_bm, st_mono_trends_stable_rich_bm)

st_cap <- paste0(
  "Repartion of the", length(st_mono_trends_stable_rich_bm), " stations used in
  the data analysis.")
```

```{r st, fig.cap = st_cap}
p_st_mono_trends_stable_rich_bm
```


## Range of variation 

```{r}
range_cap <- paste0(
  "Range of variation of variables in spatial (vertical line) and temporal
  dataset for the (A) minimum and maximum values and (B) the range (i.e. maximum
    - minimum)."
)
```


```{r range, fig.cap=range_cap, fig.height=10}
loadd(p_range)


plot_grid(plotlist = p_range, nrow = 2, labels = "AUTO")
```


## Correlation


```{r}
cor_cap <- paste0("Correlation plot among variables for spatial and temporal
  relationships. ", "Median values over temporal series in each station were
  used for spatial relationships. ", "For temporal relationships, we used the
  temporal trends in each station. Futhermore, each station was weighted by the
  average error standard on the temporal trends of the variables.")
```


```{r cor, fig.cap=cor_cap}
oldpar <- par()
loadd(corr_plot_med, corr_plot_tps)

set_names_corr <- function(mat = NULL) {
  colnames(mat) <- str_replace_all(colnames(mat), var_replacement())
  rownames(mat) <- str_replace_all(rownames(mat), var_replacement())
  return(mat)
}

corr_plot_tps %<>% set_names_corr(.)
corr_plot_med %<>% set_names_corr(.)

par(mfrow = c(1, 2))
corrplot::corrplot(corr_plot_med, type = "upper", diag = FALSE, order =
  "alphabet")
title("Spatial")
corrplot::corrplot(corr_plot_tps, type = "upper", diag = FALSE, order =
  "alphabet")
title("Temporal trends")
```

\newpage

# Statistical analysis

## Spatial model

```{r}
loadd(est_sp_models, colin_sp_models, sp_models)
```

```{r}
tmp <- map(colin_sp_models, enframe)
t_colin_sp_models <- tibble(vif = tmp, mod = names(colin_sp_models)) %>%
  unnest(vif) %>%
  filter(name %in% c("log_rich_std", "log_bm_std", "ct_ff"), mod == "log_rich_std") %>% #same model for
  #all, so the vif is the same
  rename(Response = name, vif = value) %>%
  select(-mod) %>%
  mutate(vif = map(vif, enframe)) %>%
  unnest(vif) %>%
  mutate(
    value = round(value, 3),
    name = str_replace_all(name, var_replacement()),
    Response = str_replace_all(
      Response,
      c("log_rich_std" = "Richness model", "log_bm_std" = "Biomass model",
	"ct_ff" = "Food-web structure"))
    ) %>%
  spread(name, value)


# colinearity table
kable(t_colin_sp_models,
  row.names = FALSE,
  booktabs = T,
  caption = "Variance Inflation Factor for the linear models in the spatial
  models. NA values indicate that the term in column was not included in the
  modeling of the response variable in row.",
  label = "vif-sp",
  ) %>%
  kable_styling(latex_options = c("scale_down", "stripped"))
```

## Temporal model with richness and biomass  

```{r}
loadd(
  resume_bm_rich_mod_mono_trends,
  model_bm_rich_no_covar_no_inc_mono_trends,
  reg_table_bm_rich_mono_trends,
  reg_table_bm_rich_mono_stable_trends,
  reg_table_bm_rich_trends,
  reg_table_bm_rich,
  anova_table_bm_rich_mono_trends,
  anova_table_bm_rich_mono_stable_trends,
  anova_table_bm_rich_trends,
  anova_table_bm_rich,
  anova_bm_rich_mod
)
loadd(
  st_trends_rich_bm,
  st_mono_trends_rich_bm,
  st_mono_trends_stable_rich_bm,
  basin_station
)
loadd(
  pred_bm_rich_mono_trends,
  pred_bm_rich,
  pred_bm_rich_trends,
  pred_bm_rich_mono_stable_trends
)
```

We modeled the temporal trends of food-web structure as dependant of the
temporal trends of both species richness and community biomass as: 

$dN = dB + dR + \epsilon$

\newpage

```{r sens, out.width="100%"}
# Merge reg_table
merged_reg_table <- pmap_dfr(
  list(
    df = list(
      reg_table_bm_rich_mono_trends,
      reg_table_bm_rich_mono_stable_trends,
      reg_table_bm_rich_trends,
      reg_table_bm_rich
      ),
    name = list(
      "Only monotonuous trends",
      "Monotonuous + stable trends",
      "All significant trends",
      "All trends"
      ),
    st = list(
      st_mono_trends_rich_bm,
      st_mono_trends_stable_rich_bm,
      st_trends_rich_bm,
      seq(1,400)
    )
    ), function (df, name, st) {
    df$selection <- paste0(name, " (N = ", length(st),")")
    return(select(df, selection, everything()))
  }
)

merged_reg_table %>%
  filter(! term %in% "(Intercept)", ! response %in% "piel_nind") %>%
  mutate(
   response = str_replace_all(response, var_replacement()),
   term = str_replace_all(term, var_replacement()),
  ) %>%
  ggplot(aes(x = term, y = std_estimate)) +
  geom_point(aes(color = selection)) +
  facet_grid(cols = vars(response)) +
  labs(
    x = "Explicative variable",
    y = "Standardized coefficients"
  ) +
  theme(legend.position = "bottom", axis.text.x = element_text(hjust=1, angle = 15))
```

## Interaction between community biomass trends and species richness trends

```{r}
loadd(model_bm_rich_int_mono_stable_trends)
```

### ANOVA

```{r}
model_bm_rich_int_mono_stable_trends %>%
  .[names(.) %in% c("ct_ff", "w_trph_lvl_avg", "piel_bm")] %>%
  map(., car::Anova) %>%
  map(., tidy) %>%
  map2_dfr(., names(.), ~.x %>% mutate(response = .y) %>% select(response,
      everything())) %>%
  kable(., booktabs = TRUE,
  row.names = FALSE,
  caption =
    paste0(
      "ANOVA results with interactions."
      ),
    label = "aov-int"
    ) %>%
kable_styling(latex_options =c("scale_down", "stripped")) %>%
collapse_rows(columns = 1, valign = "top")
#map(model_bm_rich_int_mono_stable_trends, ~try(car::vif(.x)))
```

```{r}
model_bm_rich_int_mono_stable_trends %>%
  .[names(.) %in% c("ct_ff", "w_trph_lvl_avg", "piel_bm")] %>%
  map(., tidy) %>%
  map2_dfr(., names(.), ~.x %>% mutate(response = .y) %>% select(response,
      everything())) %>%
  kable(., booktabs = TRUE,
  row.names = FALSE,
  caption =
    paste0(
      "Regression results with interactions."
      ),
    label = "aov-int"
    ) %>%
kable_styling(latex_options =c("scale_down", "stripped")) %>%
collapse_rows(columns = 1, valign = "top")
```

### Plots

```{r}
pred_int_rich <- map(model_bm_rich_int_mono_stable_trends,
      ~ggpredict(.x,
        terms = c("log_rich_std", "log_bm_std [quart2]")) %>%
        as_tibble() %>%
        mutate(group = as.numeric(as.character(group))) %>%
        rename("log_rich_std" = x, "log_bm_std" = group)
        ) %>%
enframe(name = "response", value = "pred_int")

ti <- pred_bm_rich_mono_stable_trends %>%
  filter(term == "log_rich_std", response %in% c("ct_ff", "w_trph_lvl_avg", "piel_bm")) %>%
  select(response, raw_plot) %>%
  left_join(pred_int_rich) %>%
  mutate(pred_plot_color = pmap(
      list(raw_plot, response, pred_int),
      function(p, resp, pred) {
        p +
          geom_line(data = pred,
            aes(
              y = predicted,
              x = log_rich_std,
              color = as.factor(log_bm_std)
            ), size = 1
          ) +
        scale_color_discrete()
      }
      )
  )
rich_leg <- get_legend(ti$pred_plot_color[[1]])

plot_grid(plotlist = map(ti$pred_plot_color, ~.x + theme(legend.position = "none")), rich_leg)
```

```{r eval = FALSE}
test <- pred_int_rich[3, ]$pred_int[[1]] %>%
  select(predicted, log_rich_std, log_bm_std) %>%
  arrange(log_rich_std, log_bm_std)

mat <- reshape2::acast(test, log_rich_std~log_bm_std, value.var = "predicted")
library(plotly)
plot_ly(
  x = ~as.numeric(colnames(mat)),
  y = ~as.numeric(rownames(mat)),
  z = ~mat) %>%
  add_surface()
```

```{r}
pred_int_bm <- map(model_bm_rich_int_mono_stable_trends,
      ~ggpredict(.x,
        terms = c("log_bm_std", "log_rich_std [quart2]")) %>%
        as_tibble() %>%
        mutate(group = as.numeric(as.character(group))) %>%
        rename("log_bm_std" = x, "log_rich_std" = group)
        ) %>%
enframe(name = "response", value = "pred_int")

ti_bm <- pred_bm_rich_mono_stable_trends %>%
  filter(term == "log_bm_std", response %in% c("ct_ff", "w_trph_lvl_avg", "piel_bm")) %>%
  select(response, raw_plot) %>%
  left_join(pred_int_bm) %>%
  mutate(pred_plot_color = pmap(
      list(raw_plot, response, pred_int),
      function(p, resp, pred) {
        p +
          geom_line(data = pred,
            aes(
              y = predicted,
              x = log_bm_std,
              color = as.factor(log_rich_std)
            ), size = 1
          ) +
        scale_color_discrete()
      }
      )
  )

bm_leg <- get_legend(ti_bm$pred_plot_color[[1]])
plot_grid(plotlist = map(ti_bm$pred_plot_color, ~.x + theme(legend.position = "none")), bm_leg)
```

```{r, echo=FALSE, eval=FALSE}
test <- model_bm_rich_int_mono_stable_trends[["ct_ff"]]
car::Anova(test)
co <- coef(test)
pred <- ggpredict(
  test,
  terms = c("log_bm_std ", "log_rich_std")
  ) %>%
  as_tibble() %>%
  mutate(group = as.numeric(as.character(group))) %>%
  rename("log_bm_std" = x, "log_rich_std" = group)

pred$y <- co[1] +
 # co["log_rich_std"] * pred[["log_rich_std"]] + bc not significant
  co["log_bm_std"] * pred[["log_bm_std"]] +
  co["log_rich_std:log_bm_std"] * pred[["log_rich_std"]] * pred[["log_bm_std"]]

# all.equal(pred$y, pred$predicted)

mat <- reshape2::acast(pred, log_rich_std~log_bm_std, value.var = "y")
library(plotly)
p <- plot_ly(
  x = ~as.numeric(colnames(mat)),
  y = ~as.numeric(rownames(mat)),
  z = ~mat, ) %>%
  add_surface() %>%
  layout(scene = list(
      xaxis = list(title = "species richness"),
      yaxis = list(title = "Community biomass"),
      zaxis = list(title = "Connectance")
      ))
```

```{r, result=FALSE}
mod4_3d <- model_bm_rich_int_mono_stable_trends[
  names(model_bm_rich_int_mono_stable_trends) %in%
    c("ct_ff", "w_trph_lvl_avg")]

pred_list <- map(mod4_3d,
  function (modl, p) {
    co <- coef(modl)
    p$y <- co[1] +
#      co["log_rich_std"] * p[["log_rich_std"]] +
      co["log_bm_std"] * p[["log_bm_std"]] +
      co["log_rich_std:log_bm_std"] * p[["log_rich_std"]] * p[["log_bm_std"]]
    return(p)

  }, p = pred)
```

```{r,result=FALSE}
mat <- reshape2::acast(
  pred_list$w_trph_lvl_avg,
  log_rich_std~log_bm_std,
  value.var = "y")
p <- plot_ly(
  x = ~as.numeric(colnames(mat)),
  y = ~as.numeric(rownames(mat)),
  z = ~mat, ) %>%
  add_surface() %>%
  layout(scene = list(
      xaxis = list(title = "Community biomass"),
      yaxis = list(title = "species richness"),
      zaxis = list(title = "Avg trophic level")
      ))
```

```{r,result=FALSE, eval=FALSE}
test <- model_bm_rich_int_mono_stable_trends[["piel_bm"]]
car::Anova(test)
co <- coef(test)
pred <- ggpredict(
  test,
  terms = c("log_bm_std ", "log_rich_std")
  ) %>%
  as_tibble() %>%
  mutate(group = as.numeric(as.character(group))) %>%
  rename("log_bm_std" = x, "log_rich_std" = group)

pred$y <- co[1] +
  co["log_rich_std"] * pred[["log_rich_std"]] +
  co["log_bm_std"] * pred[["log_bm_std"]] +
  co["log_rich_std:log_bm_std"] * pred[["log_rich_std"]] * pred[["log_bm_std"]]

# all.equal(pred$y, pred$predicted)

mat <- reshape2::acast(pred, log_rich_std~log_bm_std, value.var = "y")
p <- plot_ly(
  x = ~as.numeric(colnames(mat)),
  y = ~as.numeric(rownames(mat)),
  z = ~mat, ) %>%
  add_surface() %>%
  layout(scene = list(
      xaxis = list(title = "species richness"),
      yaxis = list(title = "Community biomass"),
      zaxis = list(title = "Eveness of biomass")
      ))
```

```{r}
p_ct_ff <- ggdraw() +
    draw_image(get_mypath("figures", "int_rich_bm_cf_ff.png"), scale = 1)
p_tlvl <- ggdraw() +
    draw_image(get_mypath("figures", "int_rich_bm_tlvl.png"), scale = 1)
p_piel_bm <- ggdraw() +
    draw_image(get_mypath("figures", "int_rich_bm_eveness.png"), scale = 1)
plot_grid(
  p_ct_ff,
  p_tlvl,
  p_piel_bm
)
```

- Results for interactions: 
  - Connectance: 
    - Always decreases when richness decreases (inverse of expectation)
    - Increases when richness increases (inverse of expectation), but always
      decreases if biomass decreases
    - Increases when biomass increases
  - Average trophic level:
    - Always decreases when biomass decreases 
    - Always increases when biomass increases 
    - Whatever the richness dynamics, it is the biomass dynamics which drives
      all
  - Pielou of biomass:
    - Always positive when biomass decreases
    - Always negative when biomass increases 

```{r}
template_cross <- tibble(
  bm_std = c("-", "0", "+"),
  `-` = c(NA, NA, NA),
  `0` = c(NA, NA, NA),
  `+` = c(NA, NA, NA),
  )

ct_ff_cross_table <- tibble(
  rich_std = c("-", "0", "+", "sign_relationship"),
  `-` = c("-", "-", "--", "-"),
  `0` = c("-", "-", "-", "0"),
  `+` = c("-", "+", "++", "+"),
  "sign_relationship" = c("0", "+", "+", "")
  )

kable(ct_ff_cross_table) %>%
  add_header_above(c(" " = 1, "bm_std" = 3))
```

```{r}
tlvl_cross_table <- tibble(
  rich_std = c("-", "0", "+", "sign_relationship"),
  `-` = c("-", "0", "+", "+"),
  `0` = c("-", "0", "+", "+"),
  `+` = c("-", "0", "+", "+"),
  "sign_relationship" = c("+", "0", "-", "")
  )

kable(tlvl_cross_table) %>%
  add_header_above(c(" " = 1, "bm_std" = 3))
```
