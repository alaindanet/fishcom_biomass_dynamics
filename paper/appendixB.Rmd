---
title: Appendix B - Dominator tree and redundancy
subtitle:
author: Alain Danet, Loubna El Madouri, Maud Mouchet, Elisa Thébault and Colin Fontaine
date: \today
output:
  bookdown::pdf_document2:
    fig_caption: true
    keep_tex: true
    toc: false
fontsize: 10pt
header-includes:
   - \newcommand{\beginsupplement}{\renewcommand{\thetable}{S\arabic{table}} \setcounter{figure}{0} \renewcommand{\thefigure}{S\arabic{figure}}}
   - \usepackage{float}
   - \usepackage{multirow}
   - \usepackage{booktabs}
   - \usepackage{makecell}
   - \usepackage{setspace}
   - \doublespacing
   - \usepackage{lineno}
   - \linenumbers
   - \renewcommand{\arraystretch}{1}
geometry: margin=2cm
bibliography: references.bib
number_sections: false
---


```{r, echo=FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.align = "center",
  fig.fullwidth = TRUE,
  fig.show = "hold",
  fig.pos = "H",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE
)
options(
  #kableExtra.latex.load_packages = FALSE,
  knitr.table.format = "latex",
  knitr.graphics.rel_path = FALSE
)
```



```{r, echo=FALSE, message=FALSE, results="hide"}
library(targets)
library(tidyverse)
library(magrittr)
library(cowplot)
library(kableExtra)
library(igraph)

mypath <- rprojroot::find_package_root_file
source(mypath("R/variable_shortcut.R")) # Define your custom code as a bunch of
#functions.
source(mypath("R/misc.R"))
source_dir(mypath("R")) # Define your custom code as a bunch of functions.

mytheme <- theme_cowplot() +
  background_grid()

theme_set(mytheme)
old_par <- par()
```

\beginsupplement

As each trophic link does not contribute equally to the robustness of an
ecological network. In particular in a food-web, ....[Explain why the metric is
really cool]

[Implementation] An developed approach is based on the use of denomitor trees
[@bodini_using_2009; @allesina_who_2004; @allesina_functional_2009].
[...] The number of functional and redundant links are straightforward to
compute We computed the number of redundant and functional links using the
dominator tree approach [@allesina_functional_2009]. A species
$i$ is a dominator of species $j$ if $i$ mediates the connection $j$ to basal
resources such as the extinction of $i$ remove the connection of $j$ to basal
resources. It is then to identify the set of trophic links that are essential to
connect species to basal resources, i.e. functional links, and the
redundant links. This method requires a single basal root in the food-webs.

Pioneer papers explained the algorithm [@bodini_using_2009] and examples.
Replicating the algorithm could seem somewhat intimitating at the time, but the
computing the dominator tree of a food-web became straightforward. In R, it is
available in `igraph::dominator_tree()`. Below is presented the function and an
example of how to use it to compute functional and redundant links.

```{r, echo = TRUE}
compute_redundancy
```

```{r}
# Get the food-web example from Bodini et al. (2009), Appendix 1 
get_bodini_graph_appendix
out <- compute_redundancy(get_bodini_graph_appendix(), root = "R")
as.data.frame(out)
```


We used this function to reproduce the
two examples (Fig. \@ref(fig:bod1), \@ref(fig:)) showcased in the Fig.1 and Appendix
1 of @bodini_using_2009 , and the example (Fig. \@ref(fig:)) presented in the Fig.1 of
@allesina_functional_2009.

(ref:bod1-cap) bodin cap

```{r bod1, fig.cap="(ref:bod1-cap)"}
par(mfrow = c(1, 2))

bodinifig1 <- get_bodini_graph_fig1()

# Complete graph
lg <- layout_as_tree(bodinifig1, root = "root")
lg[, 2] <- -lg[, 2]
plot(bodinifig1, layout = lg, main = "Redundant & Functional\nlinks")

# Only functional links
bodinifig1_dtree <- dominator_tree(bodinifig1, root = "root")
layout <- layout_as_tree(bodinifig1_dtree$domtree, root = "root")
layout[, 2] <- -layout[, 2]
plot(bodinifig1_dtree$domtree, layout = layout, main = "Functional\nlinks only")
```


```{r bod2}
par(mfrow = c(1, 2))

g <- get_bodini_graph_appendix()

# Complete graph
lg <- layout_as_tree(g, root = "R")
lg[, 2] <- -lg[, 2]
plot(g, layout = lg, main = "Redundant + Functional\nlinks")

# Only functional links
dtree <- dominator_tree(g, root = "R")
layout <- layout_as_tree(dtree$domtree, root = "R")
layout[, 2] <- -layout[, 2]
plot(dtree$domtree, layout = layout, main = "Functional\nlinks only")
```

```{r all1}
par(mfrow = c(1, 2))

allesinafig1 <- get_allesina_graph(diag = FALSE)
lg <- layout_as_tree(allesinafig1, root = "0")
lg[, 2] <- -lg[, 2]
plot(allesinafig1, layout = lg, main = "Redundant + Functional\nlinks")

# Only functional links
allesinafig1_dtree <- dominator_tree(allesinafig1, root = "0")
layout <- layout_as_tree(allesinafig1_dtree$domtree, root = "0")
layout[, 2] <- -layout[, 2]
plot(allesinafig1_dtree$domtree, layout = layout,
  main = "Functional\nlinks only")
```

```{r}
examples <- list(
  bodiniappendix = g,
  bodinifig1 = bodinifig1,
  allesinafig1 = allesinafig1
)
redundancy_examples <- map2_dfr(
  examples,
  list(bodiniappendix = "R", bodinifig1 = "root", allesinafig1 = "0"),
  ~compute_redundancy(.x, root = .y), .id = "reference")
```

```{r}
paper_replacement <- c(
  bodinifig1 = "Bodini et al. (2009) Fig. 1",
  bodiniappendix = "Bodini et al. (2009) Supp material 1",
  allesinafig1 = "Allesina et al. (2009) Fig. 1"
)

redundancy_var_replacement <- function() {
  c(
    reference = "References",
    functional_links = "Nb functional links",
    redundant_links = "Nb redundant links",
    total_links = "Nb links",
    prop_functional_links = "Prop. functional links",
    prop_redundant_links = "Prop. redundant links"
  )
}

redundancy_examples %>%
  select(reference, total_links,
    functional_links, redundant_links,
    prop_functional_links, prop_redundant_links
  ) %>%
  mutate(reference = paper_replacement[reference]) %>%
  rename_with(~redundancy_var_replacement()[.x]) %>%
  kable(
    digits = 2,
    row.names = FALSE,
    booktabs = T,
    caption = "Computation of the number (Nb) of functional, redundant links, and
    their proportion (Prop.) from previous published examples.",
    label = "inlarand") %>%
  collapse_rows(columns = c(1), valign = "top") %>%
  kable_styling(latex_options = "scale_down")
```

# References {-}
