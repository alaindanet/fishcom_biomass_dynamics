---
title: "More than space for time: revealing the tight links constraining the temporal dynamics of network structure"
author: "Alain Danet, Maud Mouchet, Loubna El Madouri, Colin Fontaine (ordre non fixÃ©)"
self_contained: yes
date: "`r Sys.Date()`"
tables: yes
bibliography: references.bib 
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE 
)
```


```{r, results = FALSE}
library(drake)
library(tidyverse)
library(magrittr)
library(cowplot)
library(viridis)
library(kableExtra)
library(sf)
mypath <- rprojroot::find_package_root_file 
source(mypath("R/variable_shortcut.R")) # Define your custom code as a bunch of functions.
source(mypath("R/misc.R"))
source_dir(get_mypath("R")) # Define your custom code as a bunch of functions.

mytheme <- theme_cowplot() +
background_grid()

theme_set(mytheme)
```

# Methods

## Data selection

## Food-web inference 

Because we had few informations about trophic interactions between resources, we
selected only the fish-fish interactions in subsequent analysis.

## Food-web and community structure

We characterized food-webs by its connectance, describing the degree of
generalism in a network [@dunne_network_2006, @delmas_analysing_2019]. It is
computed as the ratio between the actual number of links and the number of
potential links ($C = \frac{L}{S(S-1)}$, with $L$ being the number of links and
$S$ the number of trophic species). We also computed the average trophic level,
weighted by the biomass of the trophic species. The trophic level of a trophic
species is computed recursively as 1 added to the mean trophic level of the
preys that it consumes.

We described community structure by its total biomass, species richness and the
evenness of the number of individual and the amount of biomass across species. The evenness was
quantified with the Pielou index, computed as the Shannon diversity index
divided by the number of species ($P = \frac{H'}{N}$, with $H'$ being the
Shannon diversity index and $N$ the number of species).

```{r}
loadd(com_analysis_data, full_data2)
```
```{r}
nb_st <- unique(full_data2$station) %>% length
```


## Classification of temporal trajectories

With the goal to characterize the links among the temporal variations of network
and community structure and the temporal variations of community biomass and
species richness, we characterized the temporal trajectories of network and
community structure at each site. We used a method based on second order
polynomial which allows to assess both the direction and the monotony of
temporal trends [@rigal_method_2020]. To avoid complex variations of biomass and
species richness, we selected the stations that displayed monotonic trends for
theses variable. Over the `r nb_st` stations, the selection procedure resulted
in XX stations for biomass and species richness analysis.

## Spatial  

We selected the same stations that was used for the temporal analysis. 
 
# Statistical analysis

## Temporal trends 

With the aim to test (1) the relationship among the temporal dynamics of network
structure from one side and species richness and community biomass from another
side, (2) if those relationships were different if the communities were
assembling or disassembling, (3) if those relationships were different if
small/big communities, we modelled the dynamics the temporal trends of food-web
structure ($dN$) in function of the temporal trends of community biomass ($dB$) and species
richness ($dR$), if the latter was positive of not (Inc) and with respectively the median
community biomass ($B_i$) and species richness ($R_i$)of the three first years of the temporal
series .

$dN = dB + B_i + dB \times B + Inc \times B_i + dB \times Inc \times B_i$

$dN = dR + R_i + dR \times R_i + Inc \times R_i + dR \times Inc \times R_i$

With:

  - $dN$: temporal trend of network structure and communities structure
  - $dB$: temporal trend of community (log) biomass
  - $dR$: temporal trend of (log) species richness 
  - $B_i$: median community biomass of the first three year
  - $R_i$: median species richness of the first three year
  - $Inc$: Is $dB > 0$?

## Spatial trends

Spatial gradient of food-web structure are partly driven by environmental gradients, so
we controlled relationships among community structure variables by two PCA axis
synthesizing respectively (1) stream size and (2) average temperature and
enrichment. Enrichment was characterized by the average Biological Oxygen
Demand [BOD, @mallin_factors_2006].
 

$N =  B + R + E_1 + E_2 $

With:

  - $N$: median network structure and communities structure
  - $B$: median community biomass
  - $R$: median species richness 


# Results

```{r}
loadd(rsq_sp_mod, summary_table, sp_models, model_summary)
rsq <- summary_table %>%
  filter(y %in% get_com_str_var(all = FALSE), x %in% c("log_bm_std",
      "log_rich_std")) %>%
select(y, x, mod_summary_table) %>%
unnest(mod_summary_table) %>%
select(y, x, r.squared, adj.r.squared)
```

```{r}
rsq_nind_bm <- rsq[rsq$y == "piel_nind" & rsq$x == "log_bm_std",]$adj.r.squared %>%
  round(., 3)
rsq_bm_rich <- rsq[rsq$y == "log_bm_std" & rsq$x == "log_rich_std",]$adj.r.squared %>%
  round(., 3)
rsq_tlvl_rich_sp <- rsq_sp_mod$log_rich_std[
  rsq_sp_mod$log_rich_std$Response == "w_trph_lvl_avg", 
  ]$Conditional %>%
    round(., 3)
rsq_piel_bm_rich_sp <- rsq_sp_mod$log_bm_std[
  rsq_sp_mod$log_rich_std$Response == "piel_bm", 
  ]$Conditional %>%
    round(., 3)
```

Overall, we found high heterogeneity in the explicative power of statistical
models linking temporal dynamics of food-web structure and the one of community biomass and species richness spanning from $R_{adj}^2= `r rsq_nind_bm`$ for
the relationships between to $R_{adj}^2= `r rsq_bm_rich`$ between biomass and
species richness (Table \@ref(tab:rsq)). The spatial relationships among
food-web structure aspects were more performant, with $R_{cond}^2$ varing from 
`r rsq_tlvl_rich_sp` to `r rsq_piel_bm_rich_sp` (Table \@ref(tab:rsq-sp)).

Overall, we found no significant effect of the temporal gain or losses of
communinity biomass biomass and species richness on the relationship between the
temporal trends of community structure and that of biomass and species richness
(Table \@ref(tab:aov-bm), \@ref(tab:aov-rich)).

## Relationships between temporal trends 

### Food-web structure and biomass

```{r}
loadd(model_log_bm_f3y_table_medium, model_log_rich_f3y_table_medium)
reg_bm <- model_log_bm_f3y_table_medium$reg_table
#reg_bm[reg_bm$y == ]
```
We found a significant positive relationship between the temporal trends of total biomass from
one side and species richness, average trophic level, connectance from the other
side (Fig. \@ref(fig:bm), Table \@ref(tab:aov-bm)), meaning that they increased in time when
the total biomass increased in time and respectively that they decreased in time
when the total biomass decreased in time.

We found that a significant negative relationship between the temporal trends of
total biomass and that of the pielou of biomass (slopes XX, Figure X, Table X),
meaning that the eveness of biomass across species increased in time when the
total biomass decreased in time and respectively that the evenness decreased
in time when the total biomass increase in time (Fig. \@ref(fig:bm), Table
\@ref(tab:aov-bm)). However, we found no relationship between the temporal
trends of total biomass and that of the pielou
of individual.

### Community structure and species richness 

The temporal trends of total biomass, average trophic level, pielou of biomass,
pielou of individual had a positive relationship with that of species richness
(Fig. \@ref(fig:rich), Table \@ref(tab:aov-rich)). However, the direct
relationship between the temporal trends of average trophic level and the one of
species richness was not significant after controling for total biomass temporal
trends.

We also found that the relationship between the temporal trends of pielou of
individual and connectance and that of species richness was dependant of the
overall species richness of the community (Figure X, Table X). The relationship
between temporal trends of pielou of individual and that of species richness was
more positive as the community contained more species (+ XX by species by square
meter). While the relationship between temporal trends of pielou of individual
and that of species richness was more negative as the community contained more
species.

# Discussion

- Main results:
  - different mechanisms for richness and biomass
  - space for time subtitution works for biomass and tlvl but not for
    connectance

## Temporal dynamics confirms space for time substitution BEF

The temporal dynamic of the species richness was positively linked to that of
biomass. In non-temporal data, this result was already found in streams
[@woods_testing_2020; @danet_species_nodate] but also in grasslands salt marches
and forests [@hector_plant_1999; @tilman_biodiversity_2014;
@wu_relationship_2015; @li_relationship_2018; but see @grace_integrative_2016]. Therefore,
our results confirm BEF prediction works also in time.  

*From the previous manuscript*: the positive relationship of species richness on total
biomass might be due to resource use complementarity [@carey_determining_2011],
which is held by niche differentiation [@loreau_biodiversity_1998;
@loreau_partitioning_2001] or to the higher probability of getting high biomass
species with higher species richness [@loreau_biodiversity_2001].

We found the temporal dynamic of connectance was negative associated, but
weakly, with that one of species richness as found in most empirical foodweb
[@dunne_network_2006]. The relationship is very weak in species rich commuties
and more negative for species poor commuties. An explanation might be that
species-rich communities already contains a significant number of piscivores, which have the
most links whereas species poor communites contains few piscivores. 

The temporal dynamic of the average trophic level had no relationship with the
one of species richness. It is surprising because one can imagine that loss and
gain of species would reveal assembly/disassembly mechanisms in terms of trophic
structure. However, we found that when species richness increases, the
distribution of biomass and individuals among species become more even in the
community, meaning that dominance decrease. Species richness has often been
found to be positively or negatively related to individual eveness
[@soininen_relationship_2012; @maureaud_biodiversity_2019].

 
## Biomass temporal dynamics is linked to the top trophic level

We further found that the temporal dynamic of the average trophic level was positively
linked to that of biomass. Increase  of average trophic level can be associated
to either gain of biomass in the highest trophic level nor losses of biomass in
the lowest trophic. In our case, such gain or losses of average trophic level is
certainly associated to the loss or the gain of the biggest individuals. Because
it seems unlikely that a community gain or loss biomass while respectively
losing or gaining individuals. Pielou index temporal dynamics further confirm
this interpretation. 

We found that the pielou of biomass decrease through time
as total biomass decrease and reversely, meaning that biomass distribution
across species respectively became less and more even when total biomass
decrease and increase. The structuration in size class of the community might
explain this pattern.

Finally, we found no relationship between the temporal
dynamics of pielou based on indivual number and that one of biomass, confirming
that the temporal trends of total biomass in our study is linked to few big
individuals. @maureaud_biodiversity_2019 found negative relationship between
biomass and eveness of indivual in marine ecosystem. One explanation is that
marine ecosystem studied in [@maureaud_biodiversity_2019] are much larger than
the stream communities studied in this study. 

We further found that the temporal dynamic of connectance was positively
linked to that one of total biomass, meaning that connectance increases through
time in a given site when total biomass increases through time and reversely.
This is in line with the fact that the fishes located at higher trophic level
also display a larger number of links as the size of the predation window
increases with the size of the fishes. This is because the predation window of
freshwater fish species is highly nested.

##  Biomass and richness variation are not the same process 

Our results indicate that biomass trends are linked to few big individuals while
richness trends are linked to overall shift in dominance in communities. This
results has profound implications for conservation. As more and more studies
report biomass and richness temporal dynamics [@hallmann_more_2017;
@ceballos_biological_2017], it is important to note that they might not be
equivalent in terms of consequences on the structure of the community. Further
studies should investigate several dimensions of community structure because it
drives many aspects of ecosystem functioning. 

## Biomass and richness gains and losses are symmetric processes in terms of community structure

We found no case in which gain or losses of biomass and richness lead to
different relationship between the temporal dynamic of community structure and
the one of biomass and species richness. We could have imagine that
extinction/colonisation processes or immigration/extinction debt could have lead
to different relationships.

## Space for time substitution does not always hold 

We found that total biomass was linked positively related to species richness
both in space and in time, indicating that space for time might be use. In the
same way, we found a positive positive relationship between average trophic
level and total biomass both in time and in space. However, it was not the case
for connectance and average trophic level that were respectively weakly or not
linked to species richness in time whereas our result shows a strong negative
relation in space. Moreover, connectance displayed a strong positive
relationship (move to results?) with biomass in time but not in space. 

Space for time substitution is a widely
used tool in ecology [@pickett_space-for-time_1989; @blois_space_2013;
@damgaard_critique_2019]. However, the drivers of spatial variation might not
be the ones that drive community variation in time. The successional processes
driving the assembly or the disassembly of communities might not be reflected in
spatial gradient.

## Conclusion

We showed that BEF works in time but that richness and biomass temporal trends through
time relates on different ecological processes inside communities. We further
found that space for time subtitution does not always work. 


# References  {-}

<div id="refs"></div>

# Figures {-}

```{r}
loadd(p_fig1_2, sp_relation_plot2, predict_plot2)
theme_set(theme_cowplot())
p_bm <- get_plot_fig1_2(predict_plot = predict_plot2, get_list = TRUE,
  bm_x = "bm_std", rich_x = "rich_std"
  )$bm
plot_grid(plotlist = p_bm)

sp_bm <- sp_relation_plot2 %>%
  filter(x == "bm_std")
p_sp_bm <- sp_bm$gg 
names(p_sp_bm) <- sp_bm$y 

reorder_p_sp_bm <- p_sp_bm
reorder_p_sp_bm[[1]] <- p_sp_bm$ct_ff 
reorder_p_sp_bm[[2]] <- p_sp_bm$w_trph_lvl_avg 
reorder_p_sp_bm[[3]] <- p_sp_bm$piel_nind 
reorder_p_sp_bm[[4]] <- p_sp_bm$piel_bm 
reorder_p_sp_bm[[5]] <- p_sp_bm$log_rich_std 
```

```{r}
fig1_left <- plot_grid(plotlist = p_bm, ncol = 1)
fig1_right <- plot_grid(plotlist = p_sp_bm, ncol = 1)
#plot_grid(plotlist = list(p_bm[[1]], p_sp_bm[[1]], ), ncol = 1)

ti <- list()
for (i in 1:5) {
  ti[[i]] <- list(p_bm[[i]], reorder_p_sp_bm[[i]]) 
}

```

```{r bm, fig.height = 12}
# Make the label on two lines 
top <- plot_grid(plotlist = c(ti[[1]], ti[[2]], ti[[3]], ti[[4]], ti[[5]]), ncol = 2)
fig1 <- plot_grid(top, p_bm[[6]], ncol = 1, rel_heights = c(1, .1)) 
fig1
```

```{r}
p_rich <- get_plot_fig1_2(predict_plot = predict_plot2, get_list = TRUE)$rich
#plot_grid(plotlist = p_rich)


sp_rich <- sp_relation_plot2 %>%
  filter(x == "log_rich_std")
p_sp_rich <- sp_rich$gg
names(p_sp_rich) <- sp_rich$y

reorder_p_sp_rich <- p_sp_rich
reorder_p_sp_rich[[1]] <- p_sp_rich$ct_ff 
reorder_p_sp_rich[[2]] <- p_sp_rich$w_trph_lvl_avg 
reorder_p_sp_rich[[3]] <- p_sp_rich$piel_nind 
reorder_p_sp_rich[[4]] <- p_sp_rich$piel_bm 
reorder_p_sp_rich[[5]] <- p_sp_rich$log_bm_std 

```

```{r}
fig2_left <- plot_grid(plotlist = p_rich, ncol = 1)
fig2_right <- plot_grid(plotlist = p_sp_rich, ncol = 1)
#plot_grid(plotlist = list(p_bm[[1]], p_sp_bm[[1]], ), ncol = 1)

trich <- list()
for (i in 1:5) {
  trich[[i]] <- list(p_rich[[i]], reorder_p_sp_rich[[i]]) 
}
```

```{r rich, fig.height = 12}
# Make the label on two lines 
top_rich <- plot_grid(plotlist = c(trich[[1]], trich[[2]], trich[[3]], trich[[4]], trich[[5]]), ncol = 2)
fig2 <- plot_grid(top_rich, p_rich[[6]], ncol = 1, rel_heights = c(1, .1))
fig2
```

```{r}
```


# Tables

## Statistical models 

### Temporal

```{r}
loadd(model_log_bm_f3y_table_medium, model_log_rich_f3y_table_medium)
```


```{r}
model_log_bm_f3y_table_medium[["anova_table"]] %>% 
  filter(y %in% get_com_str_var(all = FALSE)) %>%
  select(-mod_summary_table) %>%
  format_anova_table() %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA results for the links between the temporal trends of 
      community biomass and the temporal trends of the network structure."
    ),
  label = "tab:aov-bm"

  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
model_log_rich_f3y_table_medium[["anova_table"]] %>% 
  filter(y %in% get_com_str_var(all = FALSE)) %>%
  select(-mod_summary_table) %>%
  format_anova_table() %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA results for the links between the temporal trends of species
      richness and the temporal trends of the network structure."
    ),
  label = "tab:aov-rich"
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
model_log_bm_f3y_table_medium$reg_table %>% 
  filter(y %in% get_com_str_var(all = FALSE)) %>%
  format_reg_table() %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "Regression coefficients for the linear models explaining the links
      between the temporal trends of community biomass and the temporal trends
      of the network structure."),
  label = "tab:reg-bm"
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
model_log_rich_f3y_table_medium$reg_table %>% 
  filter(y %in% get_com_str_var(all = FALSE)) %>%
  format_reg_table() %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "Regression coefficients for the linear models explaining the links
      between the temporal trends of species richness and the temporal trends of
      the network structure."
    ),
  label = "tab:reg-rich"
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
rsq %>%
  rename(
    Response = y, Explicative = x, 
    `Squared R` = r.squared, `Adjusted squared R` = adj.r.squared
  ) %>% 
  select(Explicative, Response, everything()) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "Squared and adjusted squared R for linear models of spatial relationships."),
  label = "tab:rsq"
      ) %>% # 
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```


### Spatial

```{r}
loadd(tab_sp_anova)
```


```{r}
tab_sp_anova$log_bm_std %>%
  mutate(
    y = str_replace_all(y, var_replacement()),
    term = str_replace_all(term, var_replacement()),
  ) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA results for the links between the spatial variation of community
      biomass and the one of network structure."),
  label = "tab:aov-bm-sp"
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
tab_sp_anova$log_rich_std %>%
  mutate(
    y = str_replace_all(y, var_replacement()),
    term = str_replace_all(term, var_replacement()),
  ) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA results for the links between the spatial variation of species
      richness and the one of network structure."),
  label = "tab:aov-rich-sp"
      ) %>% # 
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```


```{r}

table_rsq_sp <- map2(rsq_sp_mod, names(rsq_sp_mod),
  ~mutate(.x, Explicative = .y) %>%
    select(Explicative, Response, Marginal, Conditional)
) %>%
do.call(rbind, .)

table_rsq_sp %>%
  mutate(
    Explicative = str_replace_all(Explicative, var_replacement()),
    Response = str_replace_all(Response, var_replacement())
  ) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "Marginal and conditional squared R for spatial models."),
  label = "tab:rsq-sp"
      ) %>% # 
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")

```

