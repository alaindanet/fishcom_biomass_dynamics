---
title: "Report"
author: "Alain Danet"
self_contained: yes
date: "`r Sys.Date()`"
tables: yes
output:
  html_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE 
)
```


```{r}
library(drake)
library(tidyverse)
library(magrittr)
library(cowplot)
library(viridis)
library(kableExtra)
library(sf)
library(viridis)
source("R/misc.R") # Define your custom code as a bunch of functions.
source("R/variable_shortcut.R")
source_dir(get_mypath("R")) # Define your custom code as a bunch of functions.

theme_set(theme_cowplot())
```

# Research questions

## Abstract

Determine how community structure will respond to ongoing change remains an ongoing
challenge. Studies reported strong temporal trends in community biomass, notably
strong decline in insects and vertebrate populations. 

However, those studies says nothing about how empirical findings about how
different aspects of community structure such as species richness react
to a change in community biomass. 

Ecological theory might provide insight on how community structure varies
according to biomass. Especially BEF predicts a positive link between species richness and
community biomass especially in grassland.

However, communities used in BEF experiments might not be relevant to get
insight about what happens in natural settings. Firstly there are statics, i.e.
not temporal. Secondly, community composition are set to randomly and thus do
not reflect real perturbations which do not affect communities randomly. 
(to be fair one could argue that random communities can mimic an average outcome
over a set of possible perturbations, as perturbation 1 would cause extinction of species
C, perturbation 2 for species A, etc...).

Overall, we miss empirical findings about the link between biomass and
community structure.

We investigated the link between the temporal dynamics of community biomass at one side and 
species richness, connectance and average trophic level at another side using a
1995-2018 standardized monitoring of fish communities. We questionned the shape
of the link between both temporal trends.  More specifically, we questionned if
(2) the link between foodweb structure and biomass dynamics vary between growing
and shrinking communities, and if the size of the community can modulate this
response.

We found significant positive relationships the dynamics of community biomass
and the dynamics of species richness, average trophic level and connectance but
a negative one for weighted connectance. We also found this relationship was
different depending on if the community biomass was growing or shrinking through
time for all variables, suggesting that assembly processes such as colonization
processes might.


```{r}
loadd(predict_plot)
pred_plot_signif_com <- predict_plot %>%
  filter(
    y %in% c(get_com_str_var(), "log_rich_std", "piel_nind", "piel_bm"),
    x == "log_bm_std"
  )
legend_signif <- get_legend(
  pred_plot_signif_com$pred_plot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_signif_com$pred_plot %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = pred_plot_signif_com$pred_plot,
  labels = pred_plot_signif_com$y, nrow = 2
)
pred_plot1 <- plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r}
pred_plot_rich <- predict_plot %>%
  filter( y %in% c(get_com_str_var(), "bm_std", "log_bm_std", "piel_nind", "piel_bm"), x == "log_rich_std") %>%
  filter(!y %in% "rich_std")
legend_signif <- get_legend(
  pred_plot_rich$pred_plot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_rich$pred_plot %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = pred_plot_rich$pred_plot,
  labels = pred_plot_rich$y 
)
pred_plot2 <- plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r}
pred_plot_other <- predict_plot %>%
  filter( y %in% c("ct_ff", "w_trph_lvl_avg"), x %in% c("ct_ff", "w_trph_lvl_avg"))
legend_signif <- get_legend(
  pred_plot_other$pred_plot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_other$pred_plot %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = pred_plot_other$pred_plot,
  labels = pred_plot_other$y, nrow = 1
)
pred_plot3 <- plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r, fig.dim = c(12, 12)}
plot_grid( pred_plot1, pred_plot2, pred_plot3, rel_heights = c(.4, .4, .20), nrow = 3
)
```


```{r}
loadd(betapart_bin, rigal_classification, st_mono_trends_combined_list,
  summary_var_f3y)
# Rich and rich slope

mask <- st_mono_trends_combined_list$variable == "richness"
xdata <- rigal_classification %>%
  filter(variable == "richness") %>%
  unnest(classif) %>%
  filter(station %in% st_mono_trends_combined_list[mask, ]$station[[1]])

xdata %>%
  select(station, linear_slope) %>%
  left_join(summary_var_f3y %>% select(station, richness), by = "station") %>%
  ggplot(aes(x = linear_slope, y = richness)) +
  geom_point() +
  labs(x = "Slope of richness (year)", y = "richness")
```

```{r, fig.dim = c(10, 5)}
xdata <- rigal_classification %>%
  filter(variable == "log_bm_std") %>%
  unnest(classif) %>%
  filter(station %in% st_mono_trends_combined_list[mask, ]$station[[1]])

beta_xdata <- xdata %>%
  select(station, linear_slope) %>%
  left_join(betapart_bin, by = "station")

beta_xdata %>%
  pivot_longer(cols = c(beta.SIM:beta.SOR), names_to = "type", values_to = "beta") %>%
  ggplot(aes(x = linear_slope, y = beta)) +
  geom_point() +
  facet_grid(cols = vars(type)) +
  labs(x = "Slope of Log biomass (% biomass by year)", y = "Beta-diversity")

```

### Results

#### With biomass

- Species richness:
  - stables in time when biomass decreases
  - increases in time when biomass increases   
  - Difference increase/decrease
  - effect of community size! (same for the number of nodes)

- Avg trophic level:
  - decreases simultaneously with biomass decreases 
  - increase simultaneously with biomass increases but increases less for bigger
    communities
  - meaning that biomass loss and gain are located in the highest trophic level
    (except gain of biomass in biggest communities)

- Connectance:
  - do not decrease when biomass decreases in little communities
  - decreases when biomass decreases in big communities
  - do not vary when biomass increases 

- Weighted connectance:
  - increases (more even flux distribution) when biomass decreases in little communities
  - decreases (more skewed flux distribution) when biomass decreases in big communities
  - decreases when biomass increases

### Summary of result

- There are a significant link between the dynamics of community biomass and the
  dynamics of community structure for all the variables: species richness,
  average trophic level, connectance and weighted connectance.

- We found that the link between network temporal dynamics and biomass temporal
  dynamics change according if the community loses or gain biomass, for all
  variables.

- We found that the biomass of the community at the beginning of the temporal
  series, i.e. community size, had an effect on the link between network
  dynamics and biomass expect for species richness. We also found that the
  effect of biomass was stronger in communities losing biomass for connectance and
  weighted connectance but stronger in communities gaining biomass for average
  trophic level


### Answer to research questions 

- Lost and gain of biomass result in different network structure dynamics,
  suggesting that the two processes are not symmetric.
- The effect of community size suggests that the architecture of the community
  in terms of species richness, number of piscivorous species, plays a role in
  its dynamics

### Interpretation

- Richness:
  - When biomass increases, one can that species richness increases as well
    as when biomass decreases conjointly to species richness.
  - Increase in species richness necessitates colonization events, i.e.
    stochastic events while decreases in species richness necessitates
    disparition of species already in the community. Thus, the colonization
    process needs element exterior to the community.
    - Immigration debt: (might be relevant if low availability of new species)
  - second explanation: when biomass increases, competitive interactions may prevent the increase in
    species richness. We expect that processes based on competition would raise
    the role of community size.

- Avg trophic level: 
  - Higest trophic level concentrates most of the biomass, so gain and loss are
    statistically more linked to them
  - In biggest communities, there was no link between biomass and avg trophic
    level dyn because those communities already contain high trophic
    levels (There is a positive correlation between the number of pisc node and
    biomass of the community). So, there is a saturation at the top of the
    chain.
    - The observation that the number of link and link density follow the same
      pattern confirm this interpretation.

- Connectance:
  - In little communities, few piscivorous species and so loss of biomass do not
    change the foodwebs that much because fish-resource links are quite redondant.
    - there is a positive correlation between nb of pisc node and biomass.
    - In bigger communities, the loss of the highest piscivorous nodes/species
      (see average trophic level), which have a lot of interactions, leads to a
      decrease of connectance over time.
  - Increase in biomass was weakly related to an increase in node number or species
    richness, so it is not surprising that connectance to not vary.

- Connectance (fish-fish interactions):
  - Globally positive relationship
  - when biomass increases: communities gains higher trophic level that might
    explain this relationship (but species richness increase as well)
  - When biomass decreases: communities  

- Weighted connectance:
  - When biomass decreases in little communities, loss of highest trophic level
    and so less big predators and weighted connectance become more even
    - In big communities, the highest number can make the absence of such an effect 
  - When Biomass increases:
    - but species richness and number of nodes increases and gini coefficient
      does not move: so it is ninly due to the number of species
    - Gini decrease (more even link distribution) and number of species
      decrease also, so weighted_connectance should increase (it is what we see
      for low biomass communities). No idea for the difference between little
      and big communites.

The key to understand the difference between little and big communities is the
number of piscivorous nodes.

```{r}
loadd(model_log_bm_f3y_table_medium)
model_log_bm_f3y_table_medium[["anova_table"]] %>% 
  filter(y %in% get_com_str_var(all = FALSE)) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B."
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
# Get the range of variable variation in temporal data and compare it to spatial
# data

loadd(data4model, rigal_classification, full_data2, summary_var_f3y)
rigal_classification$classif[[1]]

range_spatial_variable <- summary_var_f3y %>%
  select(c("station", get_biomass_var(), get_com_str_var(all = FALSE))) %>%
  pivot_longer(!station, names_to = "variable", values_to = "values") %>%
  group_by(variable) %>% 
  summarise(min = min(values, na.rm = TRUE), max = max(values, na.rm = TRUE)) %>%
  mutate(range = max - min)

range_variable_station <- full_data2 %>% 
  select(c("station", get_biomass_var(), get_com_str_var(all = TRUE))) %>%
  pivot_longer(!station, names_to = "variable", values_to = "values") %>%
  group_by(station, variable) %>% 
  summarise(min = min(values, na.rm = TRUE), max = max(values, na.rm = TRUE))

range_variable_station %>%
  filter(variable %in% c(get_biomass_var(), get_com_str_var(all = FALSE))) %>%
  pivot_longer(cols = c(min, max), names_to = "minmax", values_to = "values") %>%
  ggplot(aes(x = values, fill = minmax)) +
  geom_histogram() +
  geom_vline(data = range_spatial_variable %>%
    pivot_longer(cols = c(min, max), names_to = "minmax", values_to = "values"),
  aes(xintercept = values, color = minmax)) + facet_wrap(~variable, scale =
  "free") 

# Range distibution 
range_variable_station %>%
  filter(variable %in% c(get_biomass_var(), get_com_str_var(all = FALSE))) %>%
  mutate(range = abs(max - min)) %>%
  ggplot(aes(x = range)) +
  geom_histogram() +
  geom_vline(data = range_spatial_variable, aes(xintercept = range)) +
  facet_wrap(~variable, scale = "free") 
```

```{r}
# Refaire temporal range avec first last year  
range_year_station <- full_data2 %>% 
  select(c("station", year, get_biomass_var(), get_com_str_var(all = TRUE))) %>%
  pivot_longer(!c(station, year), names_to = "variable", values_to = "values") %>%
  group_by(station, variable) %>% 
  summarise(min = values[year == min(year)], max = values[year == max(year)])

p_min_max_station <- range_year_station %>%
  filter(variable %in% c(get_biomass_var(), get_com_str_var(all = FALSE))) %>%
  pivot_longer(cols = c(min, max), names_to = "minmax", values_to = "values") %>%
  ggplot(aes(x = values, fill = minmax)) +
  scale_fill_viridis(discrete=TRUE) +
  scale_color_viridis(discrete=TRUE) +
  geom_histogram() +
  geom_vline(data = range_spatial_variable %>%
    pivot_longer(cols = c(min, max), names_to = "minmax", values_to = "values"),
  aes(xintercept = values, color = minmax)) + 
  facet_wrap(~variable, scale = "free", labeller = as_labeller(var_replacement()))+
  labs(fill='Value', color = "Value") 

save_plot(
  filename = get_mypath("figures/min_max_y_station.png"),
  p_min_max_station,
  ncol = 3,
  nrow = 3,
  base_height = 3.71,
  base_asp = 1.618
)



p_range_year_station <- range_year_station %>%
  filter(variable %in% c(get_biomass_var(), get_com_str_var(all = FALSE))) %>%
  mutate(
    range = abs(max - min),
    variable = str_replace_all(variable, var_replacement())
    ) %>%
  ggplot(aes(x = range)) +
  geom_histogram() +
  labs(x = "Range of variables values", y = "Frequency") +
  geom_vline(data = mutate(range_spatial_variable,
      variable = str_replace_all(variable, var_replacement())),
    aes(xintercept = range), color = "red") +
  facet_wrap(~variable, scale = "free_x") 

save_plot(
  filename = get_mypath("figures/range_y_station.png"),
  p_range_year_station,
  ncol = 3,
  nrow = 3,
  base_height = 3.71,
  base_asp = 1.618
)

# Refaire temporal range avec predict first last year

```

```{r range-tps-sp}
med_range_year_station <- range_year_station %>%
  filter(variable %in% c(get_biomass_var(), get_com_str_var(all = FALSE))) %>%
  mutate(range = abs(max - min)) %>%
  group_by(variable) %>%
  summarise(med = median(range, na.rm = TRUE))
```

### Spatial model 

#### Perform PCA

```{r}
# get all stations used in the analysis
loadd(rigal_classification, data_for_pca, pca, environment_pca)
p_pca <- my_pca_plot(.data = pca$rotated,
  xaxis = "RC1", yaxis = "RC2", ctb_thld = .4, 
  label_size = 4, force_pull = 0.01, force = 10,
  seed = 1
)
p_pca
save_plot(file = get_mypath("figures", 
	"rotated_pca_reversed_axis.pdf"),
    plot = p_pca,
    base_height = 4.5, base_asp = 1.2#1.618 
    )
```

#### Get model

```{r}
loadd(sp_models)
```

#### VIF

```{r}
tmp <- map(colin_sp_models, enframe)
  
# colinearity table
t_colin_sp_models <- tibble(vif = tmp, mod = names(colin_sp_models)) %>%
  unnest(vif) %>%
  mutate(
    mod = str_replace_all(mod, var_replacement()),
    value = round(value, 1),
    name = str_replace_all(name, var_replacement())
    ) %>%
  rename(`Response variable` = mod) %>%
  spread(name, value)

kable(t_colin_sp_models,
  booktabs = T,
  caption = "Variance Inflation Factor for the linear models used in the structural
  equation models. NA values indicate that the term in column was not included
  in the modeling of the response variable in row."
  ) %>%
  kable_styling()
```

### Plot

```{r}
loadd(sp_relation_plot2)
plot_grid(plotlist = sp_relation_plot$gg)

# Write plots:
map(sp_relation_plot$gg,
  ~save_plot(
    file = get_mypath(
      "figures", 
      paste0(
	"spatial_",
	names(.x$labels$y),
	"_",
	names(.x$labels$x),
	".png"
      )
      ),
    plot = .x,
    base_height = 2.5, base_asp = 1.2#1.618 
  ) 
)
```

## Connectance and biomass 

```{r}

loadd(est_sp_models, colin_sp_models, sp_models)
loadd(data4model, sp_st_data, summary_var_med)
data4model[1, ]$data_model[[1]]

est_sp_models$log_bm_std$ct_ff
colin_sp_models$log_bm_std$ct_ff
cf_bm_sp_mod <- sp_models$log_bm_std$ct_ff
```

On ne trouve pas d'effet de la biomasse sur la connectance, à part quand on la
controle pour la richness. Ce qui se comprend car la richness a un effet très
fort sur la connectance, qui enlève du coup beaucoup de variabilité. 

```{r}
test_sp_model <- get_mod_list(.data = as.data.frame(sp_st_data))
est_sp_models = map(test_sp_model, broom.mixed::tidy)
```
```{r}
test_mod <- lm(ct_ff ~ log_RC1 + log_RC2 + log_bm_std, as.data.frame(sp_st_data))
test_mod_rich <- lm(ct_ff ~ log_RC1 + log_RC2 + log_bm_std + log_rich_std, as.data.frame(sp_st_data))
```

## 

##

```{r}
loadd(sp_models, anova_table_sp, tab_sp_anova)

```


