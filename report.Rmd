---
title: "Report"
author: "Alain Danet"
self_contained: yes
date: "`r Sys.Date()`"
tables: yes
output:
  html_document
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE 
)
```


```{r}
library(drake)
library(tidyverse)
library(magrittr)
library(cowplot)
library(viridis)
library(kableExtra)
library(sf)
source("R/misc.R") # Define your custom code as a bunch of functions.
source("R/variable_shortcut.R")
source_dir(get_mypath("R")) # Define your custom code as a bunch of functions.

#theme_set(theme_cowplot())
```

# Research questions

## State of the art

- Report of community biomass (or number of individual) collapses in many
  ecosystems
- Modification of community are linked to modification in network structure 
- Studies have been interested in how network assembles or disassembles
  themselves.
- However, the lack of availability of such empirical dataset have prevented the
answering to this question.  
  
- Questions:
  1. Is a decrease or a increase in biomass related to a network
     structure modification?
     1.1 Is a contant decrease/increase in biomass correspond the same dynamic
     in network? Or there are non linear dynamics ?
  2. Are assembly and disassembly of networks symmetric processes?



## Links betwenn temporal dynamics



```{r b-bivar-cap}
bivar_cap <- paste0(
  "Links between temporal dynamics of biomass and temporal dynamics of
  metrics for the communities which have a median biomass across time inferior
  to the median of the station (little) and the other (big)"
)
```


```{r}
loadd(p_bm_vs_bm_slope)
p_bm_vs_bm_slope
```

```{r}
loadd(p_hist_med_bm)
p_hist_med_bm
```

# Methods 

- Methodological choice:
  - Dynamics of log of the biomass: put big and little station on the same scale
    (% of biomass gained or lost per year)


## The three model

1. $dN = dB + dB \times B + dB^2 + dB^2 \times B$

2. $dN = dB + B + dB \times B + Inc \times B + dB \times Inc \times B$

3. $dN = dB + B + dB \times B + Inc + Inc \times dB + dB \times B \times Inc$

with:
- $dN$: temporal trend of network structure
- $dB$: temporal trend of total (log) biomass
- $B$: total median biomass or total biomass of the first three year
- $Inc$: Is $dB > 0$?

We kept the second model.

# Results


```{r, cache = FALSE}
loadd(log_bm_net_group_f3y, model_log_bm_f3y,
  summary_log_bm_f3y, vif_log_bm_f3y)
#loadd(bm_net_group_median, bm_vs_net_trends)
```


#### All protocol

```{r, eval = TRUE}
#https://stackoverflow.com/questions/44457243/regression-tables-in-r-markdown-rmarkdown-html-pdf
loadd(model_log_bm_f3y_table_medium)
model_log_bm_f3y_table_medium[["reg_table"]] %>% 
  filter(variable %in% get_com_str_var(all = FALSE)) %>%
  kable(.,
    booktabs = TRUE, 
    caption = 
      paste0(
      "Regression table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B."
    )) %>% 
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
model_log_bm_f3y_table_medium[["anova_table"]] %>% 
  filter(variable %in% get_com_str_var(all = FALSE)) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B."
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

### Summary

- Lien entre dynamique du réseau et de biomasse signicatif pour tous sauf la
  connectance.
  - Pour la connectance, le lien est dépendant de la biomasse
- Effect of dis/assembly for connectance, avg trophic level, weighted
  connectance
- La dynamique du réseau n'est pas affecté par la biomasse de la
  communauté (effet biomasse non significatif)
- Il y a un effet biomasse qui est dépendant de dis/assembly.

- Species richness:
  - decreases a lot in time when biomass decreases
  - increases slightly in time when biomass increases
  - No effect of community size! (same for the number of nodes)

- Avg trophic level:
  - decreases simultaneously with biomass decreases 
  - increase simultaneously with biomass increases but increases less for bigger
    communities
  - meaning that biomass loss and gain are located in the highest trophic level
    (except gain of biomass in biggest communities)

- Connectance:
  - do not decrease when biomass decreases in little communities
  - decreases when biomass decreases in big communities
  - do not vary when biomass increases 

- Weighted connectance:
  - increases when biomass decreases in little communities
  - decreases when biomass decreases in big communities
  - decreases when biomass increases


### Interpretation

- Richness:
  - When biomass increases, one can that species richness increases as well
    as when biomass decreases conjointly to species richness.
  - Increase in species richness necessitates colonization events, i.e.
    stochastic events while decreases in species richness necessitates
    disparition of species already in the community. Thus, the colonization
    process
  - second explanation: when biomass increases, competitive interactions may prevent the increase in
    species richness. We expect that processes based on competition would raise
    the role of community size.  

- Avg trophic level: 
  - Higest trophic level concentrates most of the biomass, so gain and loss are
    statistically more linked to them
  - In biggest communities, there was no link between biomass and avg trophic
    level dyn because those communities already contain high trophic
    levels (There is a positive correlation between the number of pisc node and
    biomass of the community). So, there is a saturation at the top of the
    chain.
    - The observation that the number of link and link density follow the same
      pattern confirm this interpretation.

- Connectance:
  - In little communities, few piscivorous species and so loss of biomass do not
    change the foodwebs because fish-resource links are quite redondant.
    - there is a positive correlation between nb of pisc node and biomass.
    - In bigger communities, the loss of the highest piscivorous nodes/species
      (see average trophic level), which have a lot of interactions, leads to a
      decrease of connectance over time.
  - Increase in biomass was weakly related to an increase in node number or species
    richness, so it is not surprising that connectance to not vary.
   
- Weighted connectance:
  - When biomass decreases in little communities, loss of highest trophic level
    and so less big predators and weighted connectance become more even
    - In big communities, the highest number can make the absence of such an effect 
  - When Biomass increases, the number of predator nodes increases (especially
    in little communities), and ...
    the biomass 

The key to understand the difference between little and big communities is the
number of piscivorous nodes.

```{r}
loadd(pred_plot_signif)
pred_plot_signif_com <- pred_plot_signif %>%
  filter(variable %in% get_com_str_var())
legend_signif <- get_legend(
  pred_plot_signif_com$myplot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_signif_com$myplot %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = pred_plot_signif_com$myplot,
  labels = pred_plot_signif_com$variable
)
plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

### Further analysis

```{r}
loadd(summary_var_f3y)

summary_var_f3y %>%
  na.omit() %>%
  select(bm_std, avg_IS, l, ld, m, A, gini, log_bm_std, connectance, log_rich_std, rich_std, w_trph_lvl_avg,
    weighted_connectance, nbnode_std, nb_pisc_node_std, prop_pisc_node) %>%
  cor() %>%
  corrplot::corrplot(corr = .)

summary_var_f3y %>%
  ggplot(aes(x = bm_std, y = prop_pisc_node)) +
  geom_point() 
#summary_var_f3y %>%
  #ggplot(aes(x = log_bm_std, y = nb_pisc_node_std))+
  #geom_point() 
#summary_var_f3y %>%
  #ggplot(aes(x = , y = nb_pisc_node_std))+
  #geom_point() 
```


## Other variables 

```{r}
model_log_bm_f3y_table_medium[["anova_table"]] %>% 
  filter(!variable %in% get_com_str_var(all = FALSE)) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B."
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")

```

```{r pred-other-com, fig.dim = c(12, 10)}
plot_signif <- pred_plot_signif %>%
  filter(!variable %in% get_com_str_var())
legend_signif <- get_legend(
  plot_signif$myplot[[1]] +
    theme(legend.position = "bottom")
)
plot_signif$myplot %<>% map(., ~.x + theme(legend.position = "none"))
top_signif_other <- plot_grid(
  plotlist = plot_signif$myplot,
  labels = plot_signif$variable
)
plot_grid(top_signif_other, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r eval = FALSE}
pred_plot_signif %>%
  select(variable, data) %>%
  unnest(data) %>%
  ggplot(aes(x = bm_slope, y = linear_slope, color = bm)) +
  geom_errorbar(
    aes(xmin = bm_slope - bm_slope_strd_error, xmax = bm_slope +
      bm_slope_strd_error), alpha = .3) +
  geom_errorbar(
    aes(ymin = linear_slope - linear_slope_strd_error,
      ymax = linear_slope + linear_slope_strd_error),
    alpha = .3)
```

##

```{r}
loadd(log_bm_net_group_f3y)
st_id_plot <- log_bm_net_group_f3y %>%
  filter(variable %in% get_com_str_var()) %>%
  ggplot(aes(x = bm_slope, y = linear_slope, color = log(bm))) +
  scale_color_viridis() +
  geom_text(aes(label = station)) +
  facet_wrap(~variable, scales = "free_y")
st_id_plot
st_network_to_plot <- c(513, 1453, 16654, 6020)
```

- Station ploted: `r st_network_to_plot`

```{r}
library(tidygraph)
library(ggraph)
#source(mypath("R", "plot_methods.R"))
myload(network_analysis,
  envir = environment(),
  dir = get_mypath("data", "classes"))
myload(op_analysis,
  metaweb_analysis,
  envir = environment(),
  dir = get_mypath("data"))
meta <- metaweb_analysis; rm(metaweb_analysis)
st_sp_node <- network_analysis %>%
  select(opcod, composition) %>%
  left_join(dplyr::select(op_analysis, opcod, station, date), by = "opcod") %>%
  unnest(cols = c(composition)) %>%
  group_by(station) %>%
  summarise(
    nbnode = length(unique(sp_class)),
    nbsp = length(unique(str_extract(sp_class, "[A-Z]+")))
  ) %>%
  arrange(nbsp)

net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest(cols = c(network)) %>%
  left_join(., dplyr::select(op_analysis, opcod, station, date)) %>%
  mutate(date = lubridate::year(date)) 

myload(species_color_temporal_plot,
  envir = environment(),
  dir = get_mypath("data"))
```

```{r}
#st_id_plot
temporal_network <- map(st_network_to_plot, function (st) {
  net_ex <- filter(net, station == st)
  p <- my_crap_temporal_network(
    net = net_ex,
    metaweb = meta$metaweb,
    network_data = network_analysis,
    nrow_sp_legend = 2,
    return_data = TRUE,
    my_y_lim = c(0, 4.1),
    bm_var = "bm_std",
    color_node = species_color_temporal_plot
  )
  plot_grid(plotlist = p$plots)
  })
temporal_network[[1]]
temporal_network[[2]]
temporal_network[[3]]
temporal_network[[4]]
```

```{r}
loadd(rigal_species)
species_trends <- rigal_species %>%
  unnest(classif) %>%
  select(station, species = variable, linear_slope, linear_slope_strd_error, linear_slope_pvalue)

species_trends2 <- species_trends %>%
  left_join(filter(log_bm_net_group_f3y, variable == "connectance") %>%
    select(station, bm_slope),
    by = "station")
species_trends2 %<>% na.omit

species_trends2 %>%
  filter(linear_slope_pvalue < 0.05) %>%
  ggplot(aes(y = linear_slope, x = bm_slope, color = species)) +
  geom_point()

species_trend_cor <-
  species_trends2 %>%
  group_by(species) %>%
  summarise(
    spear = cor(linear_slope, bm_slope, method = c("spearman"), use = "pairwise.complete.obs"),
    n = n()
  ) 

species_trend_cor %>%
  filter(n >= 20) %>%
  ggplot(aes(y = spear, x = species)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 45))
```

```{r}
# Obtain avg troph lvl by species
dead_material <- c("det", "biof")
tlvl <- NetIndices::TrophInd(meta$metaweb, Dead = dead_material)$TL
names(tlvl) <- colnames(meta$metaweb) 
tlvl <- enframe(tlvl, name = "sp_class", value = "tlvl")

species_tlvl <- 
  tlvl %>%
  filter(str_detect(sp_class, "[A-Z]{3}.")) %>%
  mutate(species = str_sub(sp_class, 1, 3)) %>%
  group_by(species) %>%
  summarise(tlvl = mean(tlvl, na.rm = TRUE))
```

```{r}
species_trend_cor %>%
  left_join(species_tlvl, by = "species") %>%
  filter(n > 20) %>%
  ggplot(aes(x = tlvl, y = spear)) +
  geom_point() +
  geom_smooth(method = "lm")
```

## Link biomass dynamic and environment

```{r}
loadd(habitat_pressure, region_polygon, station_analysis)
loadd(richness_group)
loadd(log_bm_net_group_f3y)  
test <- log_bm_net_group_f3y %>%
  filter(variable == "connectance") %>%
  left_join(habitat_pressure, by = "station")
test %>%
  pivot_longer(
    cols = c(bm, width_river_mean, temperature_med, alt , RC1, RC2),
    names_to = "evt_var", values_to = "value") %>%
  ggplot(aes(y = bm_slope, x = value)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(~evt_var, scales = "free_x")
```

```{r}
p <- ggplot() +
  geom_sf(data = st_geometry(region_polygon)) 
st_bm_slope <- station_analysis %>%
  rename(station = id) %>%
  left_join(select(test, station, bm_slope)) %>%
  filter(!is.na(bm_slope)) %>%
  mutate(trend = ifelse(bm_slope < 0, "negative", "positive"))
p_col_bm_slope <- p + 
  geom_sf(data = st_bm_slope, aes(color = bm_slope)) +
  scale_color_viridis()
p_trend_bm_trend <- p +
  geom_sf(data = st_bm_slope, aes(color = trend))
plot_grid(p_col_bm_slope, p_trend_bm_trend, nrow = 1)
```

```{r}
loadd(habitat_press)
hab_press <- habitat_press %>%
  select(station, long, lat, slope, alt, d_source, strahler, width_river_mean,
    avg_depth_station_mean, DBO_med, flow_med)
dyn_press <- log_bm_net_group_f3y %>%
  filter(variable == "connectance") %>%
  select(station, bm_slope) %>%
  left_join(hab_press, by = "station") %>%
  na.omit
corrplot::corrplot(cor(dyn_press[, -1], method = "spearman"))
```

## Richness and dynamics

```{r}
log_bm_net_group_f3y %>%
  filter(variable == "rich_std", bm_slope < 0) %>%
  left_join(habitat_pressure, by = "station") %>%
  pivot_longer(cols = c(bm, width_river_mean, temperature_med, alt , RC1, RC2),
    names_to = "evt_var", values_to = "value") %>%
ggplot(aes(y = linear_slope, x = value)) +
geom_smooth(method = "lm") +
geom_point() +
facet_wrap(~evt_var, scales = "free_x")
```

```{r}
rich_std_f3y <- richness_group %>% 
  filter(rich_var == "rich_std", summary_type == "first_3_year", group_type ==
    "median") %>%
  select(station, rich)

log_bm_net_group_f3y %>%
  filter(variable == "rich_std") %>%
  left_join(rich_std_f3y, by = "station") %>%
  ggplot(aes(y = linear_slope, x = rich)) +
  geom_smooth(method = "lm") +
  labs( x = "Species richness (by m2)",
    y = "Species richness trend") +
  geom_point()
```

##



## The two models

```{r, fig.height = 12, fig.width = 12}
loadd(p_pred_quad2_f3y)
legend_quad2 <- get_legend(p_pred_quad2_f3y[[1]])
p_pred_quad2_f3y %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = p_pred_quad2_f3y,
  labels = names(p_pred_quad2_f3y)
)
quad2_plot <- plot_grid(top, legend_quad2, rel_widths = c(1, .1))
```

```{r}
loadd(p_pred_medium_f3y)
p_pred_medium_f3y %<>% map(., ~.x + theme(legend.position = "none"))
medium_plot <- plot_grid(plotlist = p_pred_medium_f3y,
  labels = names(p_pred_medium_f3y))
```

```{r, fig.height = 12}
plot_grid(quad2_plot, medium_plot, nrow = 2, labels = c("poly", "piecereg"))
```

Finally, both models does not disagree that much, for the tendancies according
to the biomass.

```{r}
loadd(log_bm_net_group_f3y, model_log_bm_f3y,
  summary_log_bm_f3y, vif_log_bm_f3y)
loadd(vif_log_bm)
```

