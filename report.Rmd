---
title: "Report"
author: "Alain Danet"
self_contained: yes
date: "`r Sys.Date()`"
tables: yes
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
    math: katex
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE 
)
```


```{r, results = FALSE}
library(drake)
library(tidyverse)
library(magrittr)
library(cowplot)
library(viridis)
library(kableExtra)
library(sf)
source("R/misc.R") # Define your custom code as a bunch of functions.
source("R/variable_shortcut.R")
source_dir(get_mypath("R")) # Define your custom code as a bunch of functions.

mytheme <- theme_cowplot() +
background_grid()

theme_set(mytheme)
```

# Results


- Species richness, Avg trophic level, connectance:
  - increases when biomass increases while decreases when biomass decreases
  - Avg trophic level: same for species richness  
  - connectance: decreases when richness increases while increases when
    richness decreases (reverse sign compared to biomass)

- Pielou (eveness) :
  - Indiv: 
    - do not varies with biomass temporal trends
    - increases with increasing temporal trends of species richness
  - Biomass: 
    - increase when biomass decreases and decreases when biomass increases
    - decreases when species richness decreases and increase when species
      richness increases

- Connectance: positive relationship with avg trophic level temporal trends

# Discussion

## Summary of result

- There was a significant positive link between the dynamics of community biomass and the
  dynamics of community structure for the variables: species richness, average trophic level, connectance except for pielou of
  individuals and pielou of biomass which had respectively a no and a negative
  relationship. 

- There was a significant positive link between the dynamics of species richness and the
  dynamics of community structure for the variables: average trophic level, connectance, pielou of
  individuals and pielou of biomass; except for connectance which had a negative
  relationship.

- There are a significant link between the dynamics of community biomass and the
  dynamics of community structure for all the variables expect pielou of
  biomass: species richness, average trophic level, connectance and pielou of
  individuals

- We found that the link between network temporal dynamics and biomass temporal
  dynamics **does not change** according if the community loses or gain biomass, for all
  variables.

## Answer to research questions 

- Lost and gain of biomass or species richness resulted in same network structure dynamics,
  suggesting that the two processes are symmetric.
- The low effect of community biomass and species richness suggests that the
  architecture of the community in terms of species richness, number of
  piscivorous species, does not play a big role in its dynamics


```{r}
loadd(predict_plot2)
pred_plot_signif_com <- predict_plot2 %>%
  filter(
    y %in% c(get_com_str_var(), "log_rich_std", "piel_nind", "piel_bm"),
    !y %in% c("bm_std", "rich_std"),
    x == "log_bm_std"
  )
legend_signif <- get_legend(
  pred_plot_signif_com$pred_plot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_signif_com %<>% 
  mutate(
  pred_plot = pmap(list(pred_plot, y, x),
    function(p, y, x) {
      # Replace label
      label <- str_replace_all(c(x,y), var_replacement(slope = TRUE)) 
      p +
	labs(x = label[1], y = label[2]) +
	theme(legend.position = "none")
    } )
  )

list_p <- pred_plot_signif_com$pred_plot
list_p[[length(list_p) + 1]] <- legend_signif

pred_plot1 <- plot_grid(
  plotlist = list_p,
  labels = "AUTO",
  nrow = 2
)
#pred_plot1 <- plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r}
pred_plot_rich <- predict_plot2 %>%
  filter( y %in% c(get_com_str_var(), "log_bm_std", "piel_nind", "piel_bm"), x == "log_rich_std") %>%
  filter(!y %in% c("rich_std"))
legend_signif <- get_legend(
  pred_plot_rich$pred_plot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_rich %<>% 
  mutate(
  pred_plot = pmap(list(pred_plot, y, x),
    function(p, y, x) {
      # Replace label
      label <- str_replace_all(c(x,y), var_replacement(slope = TRUE)) 
      p +
	labs(x = label[1], y = label[2]) +
	theme(legend.position = "none")
    } )
  )

list_p <- pred_plot_rich$pred_plot
list_p[[length(list_p) + 1]] <- legend_signif

pred_plot2 <- plot_grid(
  plotlist = list_p,
  nrow = 2,
  labels = "AUTO" 
)
#pred_plot2 <- plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r}

pred_plot_other <- predict_plot2 %>%
  filter( y %in% c("ct_ff", "w_trph_lvl_avg"), x %in% c("ct_ff", "w_trph_lvl_avg"))
legend_signif <- get_legend(
  pred_plot_other$pred_plot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_other %<>% 
  mutate(
  pred_plot = pmap(list(pred_plot, y, x),
    function(p, y, x) {
      # Replace label
      label <- str_replace_all(c(x,y), var_replacement(slope = TRUE)) 
      p +
	labs(x = label[1], y = label[2]) +
	theme(legend.position = "none")
    } )
  )

list_p <- pred_plot_other$pred_plot
list_p[[length(list_p) + 1]] <- legend_signif

pred_plot3 <- plot_grid(
  plotlist = list_p,
  labels = "AUTO", nrow = 2
)
#pred_plot3 <- plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```

```{r, fig.dim = c(10, 7)}
pred_plot1
pred_plot2
pred_plot3
```


```{r, eval = FALSE, fig.dim = c(12, 12)}
plot_grid(
  , plot_grid(, , ncol = 2, rel_widths = c(.75, 1)),
  nrow = 2
)
```

```{r, eval = FALSE, fig.dim = c(10, 5)}
loadd(betapart_bin, rigal_classification, st_mono_trends_combined_list)


mask <- st_mono_trends_combined_list$variable == "log_bm_std"
xdata <- rigal_classification %>%
  filter(variable == "log_bm_std") %>%
  unnest(classif) %>%
  filter(station %in% st_mono_trends_combined_list[mask, ]$station[[1]])

beta_xdata <- xdata %>%
  select(station, linear_slope) %>%
  left_join(betapart_bin, by = "station")

beta_xdata %>%
  pivot_longer(cols = c(beta.SIM:beta.SOR), names_to = "type", values_to = "beta") %>%
  ggplot(aes(x = linear_slope, y = beta)) +
  geom_point() +
  facet_grid(cols = vars(type)) +
  labs(x = "Slope of Log biomass (% biomass by year)", y = "Beta-diversity")

```


```{r}
#loadd(temporal_dynamics_plot)
```



```{r}
loadd(model_log_bm_f3y_table_medium)
model_log_bm_f3y_table_medium[["anova_table"]] %>%
  filter(
    y %in% c(get_com_str_var(), "ct_ff", "log_rich_std"),
    !y %in% "rich_std") %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B. The community structure versus the
      biomass"
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
loadd(model_log_rich_f3y_table_medium)
model_log_rich_f3y_table_medium[["anova_table"]] %>%
  filter(
    y %in% c(get_com_str_var(), "log_bm_std"),
    !y %in% "rich_std") %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B. The community structure versus the
      species richness"
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```


### Further analysis

```{r}
loadd(summary_var_f3y)

summary_var_f3y %>%
  na.omit() %>%
  select(bm_std, avg_IS, l, ld, m, A, gini, log_bm_std, connectance, ct_ff, rich_std, w_trph_lvl_avg,
    weighted_connectance, nbnode_std, nb_pisc_node_std, prop_pisc_node, piel_bm,
    piel_nind) %>%
  cor() %>%
  corrplot::corrplot(corr = .)
```


## Other variables 

```{r pred-other-com, fig.dim = c(12, 10)}
pred_plot_signif <- predict_plot2 %>%
  filter(!y %in% c(get_com_str_var(), "ct_ff"), x == "log_bm_std")
legend_signif2 <- get_legend(
  pred_plot_signif_com$pred_plot[[1]] + theme(legend.position = "bottom")
)
pred_plot_signif$pred_plot %<>% map(., ~.x + theme(legend.position = "none"))
top2 <- plot_grid(
  plotlist = pred_plot_signif$pred_plot,
  labels = pred_plot_signif$y
)
plot_grid(top2, legend_signif2, nrow = 2, rel_heights = c(1, .1))
```

```{r}
model_log_bm_f3y_table_medium[["anova_table"]] %>% 
  filter(!y %in% get_com_str_var(all = FALSE)) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B."
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```


```{r}
# Rich and rich slope
loadd(summary_var_f3y, st_mono_trends_combined_list, rigal_classification)

mask <- st_mono_trends_combined_list$variable == "richness"
xdata <- rigal_classification %>%
  filter(variable == "richness") %>%
  unnest(classif) %>%
  filter(station %in% st_mono_trends_combined_list[mask, ]$station[[1]])

xdata %>%
  select(station, linear_slope) %>%
  left_join(summary_var_f3y %>% select(station, richness), by = "station") %>%
  ggplot(aes(x = linear_slope, y = richness)) +
  geom_point() +
  labs(x = "Slope of richness (year)", y = "richness")
```


```{r setup,  eval = TRUE}
knitr::opts_chunk$set(eval=FALSE)
```


## Temporal series of networks

```{r}
st_id_plot <- log_bm_net_group_f3y %>%
  filter(variable %in% get_com_str_var()) %>%
  ggplot(aes(x = bm_slope, y = linear_slope, color = log(bm))) +
  scale_color_viridis() +
  geom_text(aes(label = station)) +
  facet_wrap(~variable, scales = "free_y")
st_id_plot
st_network_to_plot <- c(513, 1453, 16654, 6020)
```

- Station ploted: `r #st_network_to_plot`

```{r}
library(tidygraph)
library(ggraph)
#source(mypath("R", "plot_methods.R"))
myload(network_analysis,
  envir = environment(),
  dir = get_mypath("data", "classes"))
myload(op_analysis,
  metaweb_analysis,
  envir = environment(),
  dir = get_mypath("data"))
meta <- metaweb_analysis; rm(metaweb_analysis)
st_sp_node <- network_analysis %>%
  select(opcod, composition) %>%
  left_join(dplyr::select(op_analysis, opcod, station, date), by = "opcod") %>%
  unnest(cols = c(composition)) %>%
  group_by(station) %>%
  summarise(
    nbnode = length(unique(sp_class)),
    nbsp = length(unique(str_extract(sp_class, "[A-Z]+")))
  ) %>%
  arrange(nbsp)

net <- network_analysis %>%
  dplyr::select(opcod, network) %>%
  unnest(cols = c(network)) %>%
  left_join(., dplyr::select(op_analysis, opcod, station, date)) %>%
  mutate(date = lubridate::year(date)) 

myload(species_color_temporal_plot,
  envir = environment(),
  dir = get_mypath("data"))
```

```{r}
#st_id_plot
temporal_network <- map(st_network_to_plot, function (st) {
  net_ex <- filter(net, station == st)
  p <- my_crap_temporal_network(
    net = net_ex,
    metaweb = meta$metaweb,
    network_data = network_analysis,
    nrow_sp_legend = 2,
    return_data = TRUE,
    my_y_lim = c(0, 4.1),
    bm_var = "bm_std",
    color_node = species_color_temporal_plot
  )
  plot_grid(plotlist = p$plots)
  })
temporal_network[[1]]
temporal_network[[2]]
temporal_network[[3]]
temporal_network[[4]]
```

```{r}
loadd(rigal_species)
species_trends <- rigal_species %>%
  unnest(classif) %>%
  select(station, species = variable, linear_slope, linear_slope_strd_error, linear_slope_pvalue)

species_trends2 <- species_trends %>%
  left_join(filter(log_bm_net_group_f3y, variable == "connectance") %>%
    select(station, bm_slope),
    by = "station")
species_trends2 %<>% na.omit

species_trends2 %>%
  filter(linear_slope_pvalue < 0.05) %>%
  ggplot(aes(y = linear_slope, x = bm_slope, color = species)) +
  geom_point() +
  geom_smooth(method = "lm")

species_trend_cor <-
  species_trends2 %>%
  filter(linear_slope_pvalue < 0.05) %>%
  group_by(species) %>%
  summarise(
    spear = cor(linear_slope, bm_slope, method = c("spearman"), use = "pairwise.complete.obs"),
    n = n()
  ) 

species_trend_cor %>%
  filter(n >= 5) %>%
  ggplot(aes(y = spear, x = species)) +
  geom_bar(stat = "identity") +
  geom_label(aes(y = 0, label = paste("N=", n)), vjust = 1) +
  theme(axis.text.x = element_text(angle = 45))
```

```{r}
# Obtain avg troph lvl by species
dead_material <- c("det", "biof")
tlvl <- NetIndices::TrophInd(meta$metaweb, Dead = dead_material)$TL
names(tlvl) <- colnames(meta$metaweb) 
tlvl <- enframe(tlvl, name = "sp_class", value = "tlvl")

species_tlvl <- 
  tlvl %>%
  filter(str_detect(sp_class, "[A-Z]{3}.")) %>%
  mutate(species = str_sub(sp_class, 1, 3)) %>%
  group_by(species) %>%
  summarise(tlvl = mean(tlvl, na.rm = TRUE))
```

```{r}
species_trend_cor %>%
  left_join(species_tlvl, by = "species") %>%
  filter(n >= 5) %>%
  ggplot(aes(x = tlvl, y = spear)) +
  geom_label(aes(label = species)) +
  geom_smooth(method = "lm")
```

## Composition and biomass trajectory 

```{r}
library(vegan)
myload(com_mat, envir = environment(), dir = get_mypath("data"))

bm_slope_df <- log_bm_net_group_f3y %>% 
  filter(variable == "connectance") %>%
  select(station, bm_slope, bm) %>%
  arrange(station)

loadd(com_analysis_data, op_data)
com_mat <- compute_com_mat(
  .op = ungroup(op_data) %>% filter(station %in% bm_slope_df$station),
  com = ungroup(com_analysis_data))

com <- com_mat %>% 
  arrange(station) 
#check:
all(com$station == bm_slope_df$station)
com <- com[, colSums(com != 0) > 0] %>%
  select(-station)

```

```{r, cache = TRUE}
nmds <- metaMDS(com, k = 2, trymax = 100)
```


```{r, fig.width = 10, fig.height = 8}
diverging_pal <- c("#67001f", "#b2182b", "#d6604d", "#f4a582", "#fddbc7",
  "#f7f7f7", "#d1e5f0", "#92c5de", "#4393c3", "#2166ac", "#053061")

par(mfrow = c(1, 2))
stressplot(nmds)
title("Stress plot")
bluefunc <- colorRampPalette(c("lightyellow", "darkred"))
ordiplot(nmds,type="n")
orditorp(nmds,display="species",col="gray",air=0.01)
orditorp(nmds, display="sites",
  col= diverging_pal[findInterval(bm_slope_df$bm_slope, seq(-0.2,.2, length.out = length(diverging_pal)))],
   cex = findInterval(bm_slope_df$bm, seq(1, 4, 1))/2,
  air=0.01, pch = "+", labels = "+")
title("Color = ; Size of points = biomass")
```

## Species richness dynamics and network dynamics 

```{r}
loadd(model_log_rich_f3y_table_medium)
```

```{r}
model_log_rich_f3y_table_medium[["anova_table"]] %>% 
  filter(variable %in% get_com_str_var(all = FALSE)) %>%
  kable(., booktabs = TRUE,
    caption = 
      paste0(
      "ANOVA table for the model: dN =",
      "dB + B + dB*B + Inc*B + dB*Inc*B."
    )
  ) %>%
  kable_styling(latex_options =c("scale_down", "stripped")) %>%
  collapse_rows(columns = 1, valign = "top")
```

```{r}
loadd(pred_plot_signif_log_rich)
pred_plot_signif_log_rich_com <- pred_plot_signif_log_rich %>%
  filter(variable %in% get_com_str_var())
legend_signif <- get_legend(
  pred_plot_signif_log_rich_com$myplot[[1]] +
    theme(legend.position = "bottom")
)
pred_plot_signif_log_rich_com$myplot %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = pred_plot_signif_log_rich_com$myplot,
  labels = pred_plot_signif_log_rich_com$variable
)
plot_grid(top, legend_signif, nrow = 2, rel_heights = c(1, .1))
```


## Link biomass dynamic and environment

```{r}
loadd(habitat_pressure, region_polygon, station_analysis)
loadd(richness_group)
loadd(log_bm_net_group_f3y)  
test <- log_bm_net_group_f3y %>%
  filter(variable == "connectance") %>%
  left_join(habitat_pressure, by = "station")
test %>%
  pivot_longer(
    cols = c(bm, width_river_mean, temperature_med, alt , RC1, RC2),
    names_to = "evt_var", values_to = "value") %>%
  ggplot(aes(y = bm_slope, x = value)) +
  geom_smooth(method = "lm") +
  geom_point() +
  facet_wrap(~evt_var, scales = "free_x")
```

```{r}
p <- ggplot() +
  geom_sf(data = st_geometry(region_polygon)) 
st_bm_slope <- station_analysis %>%
  rename(station = id) %>%
  left_join(select(test, station, bm_slope)) %>%
  filter(!is.na(bm_slope)) %>%
  mutate(trend = ifelse(bm_slope < 0, "negative", "positive"))
p_col_bm_slope <- p + 
  geom_sf(data = st_bm_slope, aes(color = bm_slope)) +
  scale_color_viridis()
p_trend_bm_trend <- p +
  geom_sf(data = st_bm_slope, aes(color = trend))
plot_grid(p_col_bm_slope, p_trend_bm_trend, nrow = 1)
```

```{r}
loadd(habitat_press)
hab_press <- habitat_press %>%
  select(station, long, lat, slope, alt, d_source, strahler, width_river_mean,
    avg_depth_station_mean, DBO_med, flow_med)
dyn_press <- log_bm_net_group_f3y %>%
  filter(variable == "connectance") %>%
  select(station, bm_slope) %>%
  left_join(hab_press, by = "station") %>%
  na.omit
corrplot::corrplot(cor(dyn_press[, -1], method = "spearman"))
```

## Richness and dynamics

```{r}
log_bm_net_group_f3y %>%
  filter(variable == "rich_std", bm_slope < 0) %>%
  left_join(habitat_pressure, by = "station") %>%
  pivot_longer(cols = c(bm, width_river_mean, temperature_med, alt , RC1, RC2),
    names_to = "evt_var", values_to = "value") %>%
ggplot(aes(y = linear_slope, x = value)) +
geom_smooth(method = "lm") +
geom_point() +
facet_wrap(~evt_var, scales = "free_x")
```

```{r}
rich_std_f3y <- richness_group %>% 
  filter(rich_var == "rich_std", summary_type == "first_3_year", group_type ==
    "median") %>%
  select(station, rich)

log_bm_net_group_f3y %>%
  filter(variable == "rich_std") %>%
  left_join(rich_std_f3y, by = "station") %>%
  ggplot(aes(y = linear_slope, x = rich)) +
  geom_smooth(method = "lm") +
  labs( x = "Species richness (by m2)",
    y = "Species richness trend") +
  geom_point()
```

##



## The two models

```{r, fig.height = 12, fig.width = 12}
loadd(p_pred_quad2_f3y)
legend_quad2 <- get_legend(p_pred_quad2_f3y[[1]])
p_pred_quad2_f3y %<>% map(., ~.x + theme(legend.position = "none"))
top <- plot_grid(
  plotlist = p_pred_quad2_f3y,
  labels = names(p_pred_quad2_f3y)
)
quad2_plot <- plot_grid(top, legend_quad2, rel_widths = c(1, .1))
```

```{r}
loadd(p_pred_medium_f3y)
p_pred_medium_f3y %<>% map(., ~.x + theme(legend.position = "none"))
medium_plot <- plot_grid(plotlist = p_pred_medium_f3y,
  labels = names(p_pred_medium_f3y))
```

```{r, fig.height = 12}
plot_grid(quad2_plot, medium_plot, nrow = 2, labels = c("poly", "piecereg"))
```

Finally, both models does not disagree that much, for the tendancies according
to the biomass.

```{r}
loadd(log_bm_net_group_f3y, model_log_bm_f3y,
  summary_log_bm_f3y, vif_log_bm_f3y)
loadd(vif_log_bm)
```

```{r}
loadd(p_bm_vs_bm_slope)
p_bm_vs_bm_slope
```

```{r}
loadd(p_hist_med_bm)
p_hist_med_bm
```

# Methods 

- Methodological choice:
  - Dynamics of log of the biomass: put big and little station on the same scale
    (% of biomass gained or lost per year)



2. $dN = dB + B + dB \times B + Inc \times B + dB \times Inc \times B$

with:
- $dN$: temporal trend of network structure
- $dB$: temporal trend of total (log) biomass
- $B$: total median biomass or total biomass of the first three year
- $Inc$: Is $dB > 0$?

We kept the second model.

