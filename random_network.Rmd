---
title: "Extinction simulation on the metaweb"
author: AD 
date: \today
output:
  bookdown::pdf_document2:
    toc: true
---

#

- Nombre de liens in and out 

- Simulation avec degree in + out (somme des colonnes et des lignes)
- Rajouter extinction secondaire

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  echo = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.asp = .5, 
  fig.show = "hold",
  message = FALSE,
  warning = FALSE,
  results = TRUE
)
```
```{r, echo = FALSE, results = FALSE}
library(drake)
library(ggformula)
mypath <- rprojroot::find_package_root_file
source(mypath("R/misc.R"))
source(mypath("R/variable_shortcut.R")) # Define your custom code as a bunch of functions.
source_dir(get_mypath("R")) # Define your custom code as a bunch of functions.

mytheme <- theme_cowplot() +
background_grid()

theme_set(mytheme)
```

```{r}
load(mypath("data", "metaweb_analysis.rda"))
```
```{r}
metaweb <- metaweb_analysis$metaweb
# node seq
node_tlvl <- NetIndices::TrophInd(metaweb)$TL
names(node_tlvl) <- colnames(metaweb_analysis$metaweb)
# 
metric_to_keep <- c("ct", "ct_ff", "avg_tl", "avg_tl_ff", "max_tl", "max_tl_ff")

# species
fish_species_tlvl <- node_tlvl %>%
  enframe(name = "node", value = "tlvl") %>%
  mutate(species = get_species(node)[, 1]) %>%
  filter(str_detect(species, "[A-Z]+")) %>%
  group_by(species) %>%
  summarise(tlvl_med = median(tlvl)) %>%
  arrange(desc(tlvl_med)) %>%
  deframe()
```

```{r, eval = FALSE}
node_seq <- sort(node_tlvl, decreasing = TRUE)
node_fish_seq <- node_seq[fish(names(node_seq))]

node_extinction_inc_dec_tlvl <- tibble(
  node_rm_single = names(node_fish_seq),
  node_tlvl = node_fish_seq,
  node_rm_tot = map(seq_along(node_fish_seq),
      ~node_fish_seq[1:.x]),
  metaweb = map(
  seq_along(node_fish_seq),
  ~metaweb[
    !rownames(metaweb) %in% names(node_fish_seq)[1:.x],
    !colnames(metaweb) %in% names(node_fish_seq)[1:.x]
    ]
)
)
```
```{r, eval=FALSE}
node_extinction_inc_dec_tlvl_metrics <-
  node_extinction_inc_dec_tlvl %>%
    mutate(
      fish_fish_net = map(metaweb, get_fish_fish_matrix),
      metrics = map(metaweb, NetIndices::GenInd),
      ff_metrics = map(fish_fish_net, NetIndices::GenInd),
      ct = map_dbl(metrics, "C"),
      ct_ff = map_dbl(ff_metrics, "C"),
      tl = map(metaweb, ~max(NetIndices::TrophInd(.x)$TL)),
      tl_ff = map(fish_fish_net, ~max(NetIndices::TrophInd(.x)$TL))
    )
```


```{r}
```

```{r}
node_seq_dec_tlvl <- sort(node_tlvl, decreasing = TRUE)
node_seq_inc_tlvl <- sort(node_tlvl, decreasing = FALSE)
node_fish_seq_dec_tlvl <- node_seq_dec_tlvl[fish(names(node_seq_dec_tlvl))]
node_fish_seq_inc_tlvl <- node_seq_inc_tlvl[fish(names(node_seq_inc_tlvl))]
```


```{r, eval=FALSE}
library(furrr)
plan(sequential)
sim_dec_tlvl <- get_sim_net(net = metaweb, ext_seq = node_fish_seq_dec_tlvl,
  keep_metaweb = FALSE)
sim_inc_tlvl <- get_sim_net(net = metaweb, ext_seq = node_fish_seq_inc_tlvl,
  keep_metaweb = FALSE
)

nsim <- 10
sim_random_tlvl <- tibble(
  repl = seq_len(nsim),
  sim = furrr::future_map(repl,
    ~get_sim_net(net = metaweb, ext_seq = sample(node_fish_seq_inc_tlvl),
      keep_metaweb = FALSE)
  )
)

sim_dec_tlvl %<>%
  mutate(met = map(metrics, ~enframe(unlist(.x[metric_to_keep])))) %>%
  unnest(met) %>%
  pivot_wider(names_from = "name", values_from = "value")
save(file = mypath("data", "sim_dec_tlvl.rda"), sim_dec_tlvl)

sim_inc_tlvl %<>%
  mutate(met = map(metrics, ~enframe(unlist(.x[metric_to_keep])))) %>%
  unnest(met) %>%
  pivot_wider(names_from = "name", values_from = "value")
save(file = mypath("data", "sim_inc_tlvl.rda"), sim_inc_tlvl)

sim_random_tlvl %<>%
  mutate(res = map(sim, function(x) {
      x %>%
      mutate(met = map(metrics, ~enframe(unlist(.x[metric_to_keep])))) %>%
      unnest(met) %>%
      pivot_wider(names_from = "name", values_from = "value")
  })) %>%
unnest(res)
save(file = mypath("data", "sim_random_tlvl.rda"), sim_random_tlvl)
```

```{r random-richness, eval = FALSE}
save(file = mypath("data", "sim_dec_sp_tlvl.rda"), dec_species_result)
save(file = mypath("data", "sim_inc_sp_tlvl.rda"), inc_species_result)
```

```{r, eval = FALSE}
# random simulation
save(file = mypath("data", "sim_random_sp_tlvl.rda"), random_species_result)
```

# Results

## Node

```{r}
load(mypath("data", "sim_dec_tlvl.rda"))
load(mypath("data", "sim_inc_tlvl.rda"))
load(mypath("data", "sim_random_tlvl.rda"))
```

```{r}
rand_node_tmp <- sim_random_tlvl %>%
  unnest(sim) %>%
  mutate(
    met = map(metrics, ~enframe(unlist(.x[metric_to_keep]))),
    nb_ext = map_int(node_rm_tot, length),
    type = "random",
    extinct = "node"
    ) %>%
  unnest(met) %>%
  rename(metric = name)

sim_node_dec_inc <- rbind(
  sim_dec_tlvl %>%
    pivot_longer(!!metric_to_keep, names_to = "metric", values_to = "value") %>%
    mutate(
    type = "decreasing",
    extinct = "node"
  ),
  sim_inc_tlvl %>%
    pivot_longer(!!metric_to_keep, names_to = "metric", values_to = "value") %>%
    mutate(
      type = "increasing",
      extinct = "node"
    )
)
```

```{r}
p_ext_node <- sim_node_dec_inc %>%
  filter(str_detect(metric, "_ff")) %>%
  mutate(
    nb_ext = map_int(node_rm_tot, length),
    metric = var_replacement()[metric],
    type = str_to_sentence(type)
    ) %>%
  ggplot(aes(x = nb_ext, y = value, color = type)) +
  geom_line() +
  geom_point(data = rand_node_tmp %>%
    filter(str_detect(metric, "_ff")) %>%
    mutate(
      metric = var_replacement()[metric],
      type = str_to_sentence(type)
    )) +
  geom_smooth(data = rand_node_tmp %>%
    filter(str_detect(metric, "_ff")) %>%
    mutate(
      metric = var_replacement()[metric],
      type = str_to_sentence(type)
    ), color = "black") +
  facet_wrap(~metric, scale = "free_y") +
  labs(y = "Network metric values",
    x = "Number of node removed",
    color = "Trophic level scenario") +
  theme(legend.position = "bottom")
```


## Species

```{r}
load(file = mypath("data", "sim_random_sp_tlvl.rda"))
load(file = mypath("data", "sim_dec_sp_tlvl.rda"))
load(file = mypath("data", "sim_inc_sp_tlvl.rda"))
```


```{r}
sim_sp_dec_inc <- rbind(
  inc_species_result %>%
    mutate(
      met = map(metrics, ~enframe(unlist(.x[metric_to_keep]))),
      nb_ext = map_int(species_removed, length),
      type = "increasing",
      extinct = "species"
      ) %>%
  unnest(met) %>%
  rename(metric = name),
dec_species_result %>%
  mutate(
    met = map(metrics, ~enframe(unlist(.x[metric_to_keep]))),
    nb_ext = map_int(species_removed, length),
    type = "decreasing",
    extinct = "species"
    ) %>%
  unnest(met) %>%
  rename(metric = name)
)

rand_sp_met <- random_species_result %>%
  unnest(metrics) %>%
  mutate(
    met = map(metrics, ~enframe(unlist(.x[metric_to_keep]))),
    nb_ext = nsp_rm,
    type = "random",
    extinct = "species"
    ) %>%
  unnest(met) %>%
  rename(metric = name)
```

```{r}
p_ext_sp <- sim_sp_dec_inc %>%
  filter(str_detect(metric, "_ff")) %>%
  mutate(
    metric = var_replacement()[metric],
    type = str_to_sentence(type)
    ) %>%
  ggplot(aes(x = nb_ext, y = value, color = type)) +
  geom_line() +
  geom_point(
    data = rand_sp_met %>%
    filter(str_detect(metric, "_ff")) %>%
    mutate(
      metric = var_replacement()[metric],
      type = str_to_sentence(type)
    )) +
  geom_smooth(data = rand_sp_met %>%
    filter(str_detect(metric, "_ff")) %>%
    mutate(
      metric = var_replacement()[metric],
      type = str_to_sentence(type)
    ), color = "black") +
  facet_wrap(~metric, scale = "free_y") +
  labs(y = "Network metric values", x = "Number of species removed",
    color = "Trophic level scenario") +
  theme(legend.position = "bottom")
p_ext_node
```

```{r}
model_res <- rand_sp_met %>%
  select(metric, value, nb_ext) %>%
  filter(str_detect(metric, "_ff")) %>%
  nest_by(metric) %>%
  mutate(
    mod = list(lm(value ~ nb_ext, data)),
    coefs = list(broom::tidy(mod))
  ) %>%
  unnest(coefs) %>%
  filter(term == "nb_ext")
```


